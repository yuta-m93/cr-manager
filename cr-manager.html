<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CR Manager â€” ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€å…ƒç®¡ç†</title>
<style>
  :root {
    --primary: #2563EB;
    --primary-dark: #1D4ED8;
    --primary-light: #EFF6FF;
    --purple: #7C3AED;
    --purple-light: #F5F3FF;
    --success: #059669;
    --success-light: #ECFDF5;
    --warning: #D97706;
    --warning-light: #FFFBEB;
    --danger: #DC2626;
    --danger-light: #FEF2F2;
    --slate-900: #0F172A;
    --slate-800: #1E293B;
    --slate-700: #334155;
    --slate-600: #475569;
    --slate-500: #64748B;
    --slate-400: #94A3B8;
    --slate-300: #CBD5E1;
    --slate-200: #E2E8F0;
    --slate-100: #F1F5F9;
    --slate-50: #F8FAFC;
    --white: #FFFFFF;
    --sidebar-w: 240px;
    --header-h: 60px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
    background: var(--slate-50);
    color: var(--slate-800);
    font-size: 14px;
    line-height: 1.5;
  }

  /* â”€â”€â”€ LOGIN â”€â”€â”€ */
  #loginScreen {
    position: fixed; inset: 0;
    background: linear-gradient(135deg, #1E293B 0%, #0F172A 50%, #1e3a5f 100%);
    display: flex; align-items: center; justify-content: center;
    z-index: 100;
  }
  .login-card {
    background: var(--white);
    border-radius: 16px;
    padding: 48px 40px;
    width: 420px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.35);
  }
  .login-logo {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 32px;
  }
  .login-logo-icon {
    width: 44px; height: 44px;
    background: linear-gradient(135deg, var(--primary), var(--purple));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    color: white; font-size: 20px; font-weight: 800;
  }
  .login-logo-text { font-size: 22px; font-weight: 700; color: var(--slate-800); }
  .login-logo-sub { font-size: 11px; color: var(--slate-500); margin-top: 2px; }
  .login-title { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
  .login-desc { color: var(--slate-500); font-size: 13px; margin-bottom: 28px; }
  .role-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 24px; }
  .role-btn {
    border: 2px solid var(--slate-200);
    background: var(--white);
    border-radius: 10px;
    padding: 14px 12px;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
  }
  .role-btn:hover { border-color: var(--primary); background: var(--primary-light); }
  .role-btn.active { border-color: var(--primary); background: var(--primary-light); }
  .role-btn .role-icon { font-size: 24px; margin-bottom: 6px; }
  .role-btn .role-name { font-size: 13px; font-weight: 600; color: var(--slate-700); }
  .role-btn .role-desc { font-size: 11px; color: var(--slate-500); margin-top: 2px; }
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--slate-600); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
  .form-input {
    width: 100%; padding: 10px 14px;
    border: 1.5px solid var(--slate-200);
    border-radius: 8px;
    font-size: 14px;
    color: var(--slate-800);
    background: var(--slate-50);
    transition: border-color 0.15s;
  }
  .form-input:focus { outline: none; border-color: var(--primary); background: var(--white); }
  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 14px; font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    text-decoration: none;
  }
  .btn-primary {
    background: var(--primary);
    color: var(--white);
    width: 100%;
    padding: 12px;
    font-size: 15px;
  }
  .btn-primary:hover { background: var(--primary-dark); }
  .btn-ghost { background: transparent; color: var(--slate-600); border: 1.5px solid var(--slate-200); }
  .btn-ghost:hover { background: var(--slate-100); }
  .btn-success { background: var(--success); color: white; }
  .btn-success:hover { background: #047857; }
  .btn-danger { background: var(--danger); color: white; }
  .btn-danger:hover { background: #B91C1C; }
  .btn-warning { background: var(--warning); color: white; }
  .btn-warning:hover { background: #B45309; }
  .btn-purple { background: var(--purple); color: white; }
  .btn-purple:hover { background: #6D28D9; }
  .btn-sm { padding: 6px 12px; font-size: 13px; }
  .btn-xs { padding: 4px 8px; font-size: 12px; border-radius: 6px; }

  /* â”€â”€â”€ APP SHELL â”€â”€â”€ */
  #appShell { display: none; }
  #appShell.visible { display: flex; height: 100vh; overflow: hidden; }

  /* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
  .sidebar {
    width: var(--sidebar-w);
    background: var(--slate-900);
    display: flex; flex-direction: column;
    flex-shrink: 0;
    overflow-y: auto;
  }
  .sidebar-logo {
    display: flex; align-items: center; gap: 10px;
    padding: 18px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  .sidebar-logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--primary), var(--purple));
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    color: white; font-size: 16px; font-weight: 800;
    flex-shrink: 0;
  }
  .sidebar-logo-text { color: white; font-size: 16px; font-weight: 700; }
  .sidebar-logo-sub { color: var(--slate-400); font-size: 10px; }
  .sidebar-user {
    display: flex; align-items: center; gap: 10px;
    padding: 14px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    margin-bottom: 8px;
  }
  .user-avatar {
    width: 34px; height: 34px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 700; color: white;
    flex-shrink: 0;
  }
  .user-name { color: white; font-size: 13px; font-weight: 600; }
  .user-role-badge {
    display: inline-block;
    font-size: 10px; font-weight: 600;
    padding: 1px 6px;
    border-radius: 10px;
    margin-top: 2px;
  }
  .badge-agency { background: rgba(37,99,235,0.3); color: #93C5FD; }
  .badge-client { background: rgba(124,58,237,0.3); color: #C4B5FD; }
  .nav-section { padding: 0 12px; margin-bottom: 8px; }
  .nav-section-title { font-size: 10px; font-weight: 700; color: var(--slate-500); text-transform: uppercase; letter-spacing: 0.08em; padding: 8px 8px 4px; }
  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 10px;
    border-radius: 8px;
    color: var(--slate-400);
    cursor: pointer;
    font-size: 13.5px;
    font-weight: 500;
    margin-bottom: 1px;
    transition: all 0.12s;
    user-select: none;
  }
  .nav-item:hover { background: rgba(255,255,255,0.06); color: var(--slate-200); }
  .nav-item.active { background: rgba(37,99,235,0.2); color: #93C5FD; }
  .nav-icon { font-size: 16px; flex-shrink: 0; width: 20px; text-align: center; }
  .nav-badge {
    margin-left: auto;
    background: var(--danger);
    color: white;
    font-size: 10px; font-weight: 700;
    padding: 1px 6px;
    border-radius: 10px;
  }
  .sidebar-bottom {
    margin-top: auto;
    padding: 16px 12px;
    border-top: 1px solid rgba(255,255,255,0.08);
  }
  .logout-btn {
    display: flex; align-items: center; gap: 8px;
    color: var(--slate-500);
    cursor: pointer;
    font-size: 13px;
    padding: 8px 10px;
    border-radius: 8px;
    transition: all 0.12s;
  }
  .logout-btn:hover { color: var(--slate-300); background: rgba(255,255,255,0.05); }

  /* â”€â”€â”€ MAIN â”€â”€â”€ */
  .main-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .page-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 28px;
    height: var(--header-h);
    background: var(--white);
    border-bottom: 1px solid var(--slate-200);
    flex-shrink: 0;
  }
  .page-title { font-size: 17px; font-weight: 700; color: var(--slate-800); }
  .page-header-actions { display: flex; gap: 8px; }
  .page-content { flex: 1; overflow-y: auto; padding: 24px 28px; }

  /* â”€â”€â”€ VIEWS â”€â”€â”€ */
  .view { display: none; }
  .view.active { display: block; }

  /* â”€â”€â”€ STATS â”€â”€â”€ */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .stat-card {
    background: var(--white);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid var(--slate-200);
  }
  .stat-label { font-size: 12px; font-weight: 600; color: var(--slate-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
  .stat-value { font-size: 28px; font-weight: 800; color: var(--slate-800); }
  .stat-sub { font-size: 12px; color: var(--slate-500); margin-top: 4px; }
  .stat-bar { height: 3px; background: var(--slate-100); border-radius: 2px; margin-top: 12px; overflow: hidden; }
  .stat-bar-fill { height: 100%; border-radius: 2px; }

  /* â”€â”€â”€ CARDS â”€â”€â”€ */
  .card {
    background: var(--white);
    border-radius: 12px;
    border: 1px solid var(--slate-200);
    overflow: hidden;
  }
  .card-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--slate-100);
  }
  .card-title { font-size: 15px; font-weight: 700; color: var(--slate-800); }
  .card-body { padding: 20px; }

  /* â”€â”€â”€ STATUS BADGES â”€â”€â”€ */
  .status-badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 12px; font-weight: 600;
  }
  .status-draft { background: var(--slate-100); color: var(--slate-600); }
  .status-submitted { background: #EFF6FF; color: #2563EB; }
  .status-reviewing { background: #FFFBEB; color: #D97706; }
  .status-approved { background: var(--success-light); color: var(--success); }
  .status-revision { background: #FFF7ED; color: #EA580C; }
  .status-rejected { background: var(--danger-light); color: var(--danger); }

  /* â”€â”€â”€ CR LIST TABLE â”€â”€â”€ */
  .filter-bar {
    display: flex; gap: 10px; align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .filter-input {
    padding: 8px 14px;
    border: 1.5px solid var(--slate-200);
    border-radius: 8px;
    font-size: 13.5px;
    color: var(--slate-700);
    background: var(--white);
    transition: border-color 0.15s;
    min-width: 200px;
  }
  .filter-input:focus { outline: none; border-color: var(--primary); }
  .filter-select {
    padding: 8px 14px;
    border: 1.5px solid var(--slate-200);
    border-radius: 8px;
    font-size: 13.5px;
    color: var(--slate-700);
    background: var(--white);
    cursor: pointer;
  }
  .cr-table { width: 100%; border-collapse: collapse; }
  .cr-table th {
    text-align: left;
    font-size: 11px; font-weight: 700;
    color: var(--slate-500);
    text-transform: uppercase; letter-spacing: 0.06em;
    padding: 10px 16px;
    background: var(--slate-50);
    border-bottom: 1px solid var(--slate-200);
  }
  .cr-table td {
    padding: 14px 16px;
    border-bottom: 1px solid var(--slate-100);
    vertical-align: middle;
  }
  .cr-table tr:last-child td { border-bottom: none; }
  .cr-table tr:hover td { background: var(--slate-50); }
  .cr-table tr { cursor: pointer; transition: background 0.1s; }
  .cr-id { font-size: 12px; font-weight: 700; color: var(--slate-500); }
  .cr-name { font-weight: 600; color: var(--slate-800); margin-bottom: 2px; }
  .cr-client { font-size: 12px; color: var(--slate-500); }
  .cr-date { font-size: 13px; color: var(--slate-600); }
  .risk-badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 12px; font-weight: 600;
  }
  .risk-critical { background: #FEE2E2; color: #DC2626; }
  .risk-high { background: #FEF3C7; color: #D97706; }
  .risk-medium { background: #FEF9C3; color: #CA8A04; }
  .risk-low { background: #DCFCE7; color: #16A34A; }
  .risk-none { background: var(--slate-100); color: var(--slate-500); }

  /* â”€â”€â”€ CR DETAIL â”€â”€â”€ */
  .detail-grid { display: grid; grid-template-columns: 1fr 360px; gap: 20px; }
  .detail-main { display: flex; flex-direction: column; gap: 16px; }
  .detail-sidebar { display: flex; flex-direction: column; gap: 16px; }
  .back-btn {
    display: inline-flex; align-items: center; gap: 6px;
    color: var(--slate-500); font-size: 13px;
    cursor: pointer; margin-bottom: 16px;
    transition: color 0.12s;
  }
  .back-btn:hover { color: var(--slate-700); }
  .detail-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    margin-bottom: 16px;
  }
  .detail-title { font-size: 20px; font-weight: 800; color: var(--slate-800); }
  .detail-meta { display: flex; gap: 16px; margin-top: 8px; flex-wrap: wrap; }
  .meta-item { font-size: 12.5px; color: var(--slate-500); }
  .meta-item strong { color: var(--slate-700); }

  /* â”€â”€â”€ AI CHECK RESULTS â”€â”€â”€ */
  .ai-check-banner {
    border-radius: 10px;
    padding: 14px 18px;
    margin-bottom: 16px;
    display: flex; align-items: center; gap: 12px;
  }
  .ai-check-critical { background: #FEF2F2; border: 1px solid #FECACA; }
  .ai-check-warning { background: #FFFBEB; border: 1px solid #FDE68A; }
  .ai-check-safe { background: var(--success-light); border: 1px solid #A7F3D0; }
  .ai-icon { font-size: 22px; }
  .ai-summary-title { font-weight: 700; font-size: 14px; }
  .ai-summary-desc { font-size: 13px; color: var(--slate-600); margin-top: 2px; }

  .check-items { display: flex; flex-direction: column; gap: 10px; }
  .check-item {
    border-radius: 10px;
    border: 1px solid;
    overflow: hidden;
  }
  .check-item-critical { border-color: #FECACA; }
  .check-item-high { border-color: #FDE68A; }
  .check-item-medium { border-color: #FEF08A; }
  .check-item-low { border-color: #BBF7D0; }
  .check-item-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 14px;
    cursor: pointer;
  }
  .check-item-critical .check-item-header { background: #FEF2F2; }
  .check-item-high .check-item-header { background: #FFFBEB; }
  .check-item-medium .check-item-header { background: #FEFCE8; }
  .check-item-low .check-item-header { background: #F0FDF4; }
  .check-item-title { font-weight: 600; font-size: 13px; }
  .check-item-body { padding: 12px 14px; background: white; }
  .violation-text {
    background: var(--slate-50);
    border-left: 3px solid;
    padding: 8px 12px;
    border-radius: 0 6px 6px 0;
    font-size: 13px;
    margin-bottom: 8px;
  }
  .violation-text-critical { border-color: #DC2626; }
  .violation-text-high { border-color: #D97706; }
  .violation-text-medium { border-color: #CA8A04; }
  .highlight-critical { background: #FEE2E2; padding: 1px 3px; border-radius: 3px; font-weight: 700; color: #991B1B; }
  .highlight-high { background: #FEF3C7; padding: 1px 3px; border-radius: 3px; font-weight: 700; color: #92400E; }
  .highlight-medium { background: #FEF9C3; padding: 1px 3px; border-radius: 3px; font-weight: 700; color: #713F12; }
  .violation-reason { font-size: 12.5px; color: var(--slate-600); margin-top: 6px; }
  .suggestion-box {
    background: var(--primary-light);
    border: 1px solid #BFDBFE;
    border-radius: 8px;
    padding: 10px 12px;
    margin-top: 8px;
    font-size: 12.5px;
  }
  .suggestion-label { font-weight: 700; color: var(--primary); font-size: 11px; text-transform: uppercase; margin-bottom: 4px; }
  .suggestion-text { color: var(--slate-700); }

  /* â”€â”€â”€ TEXT DISPLAY â”€â”€â”€ */
  .copy-text {
    background: var(--slate-50);
    border: 1px solid var(--slate-200);
    border-radius: 10px;
    padding: 16px;
    font-size: 14px;
    line-height: 1.8;
    color: var(--slate-700);
    white-space: pre-wrap;
    word-break: break-word;
  }
  .copy-text .hl-critical { background: rgba(220,38,38,0.15); border-bottom: 2px solid #DC2626; padding: 1px 2px; border-radius: 2px; }
  .copy-text .hl-high { background: rgba(217,119,6,0.15); border-bottom: 2px solid #D97706; padding: 1px 2px; border-radius: 2px; }
  .copy-text .hl-medium { background: rgba(202,138,4,0.12); border-bottom: 2px solid #CA8A04; padding: 1px 2px; border-radius: 2px; }

  /* â”€â”€â”€ COMMENTS â”€â”€â”€ */
  .comment-list { display: flex; flex-direction: column; gap: 12px; }
  .comment-item { display: flex; gap: 10px; }
  .comment-avatar {
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; color: white;
    flex-shrink: 0;
  }
  .comment-bubble {
    flex: 1;
    background: var(--slate-50);
    border: 1px solid var(--slate-200);
    border-radius: 10px;
    padding: 10px 14px;
  }
  .comment-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .comment-author { font-size: 13px; font-weight: 700; }
  .comment-time { font-size: 11px; color: var(--slate-400); }
  .comment-text { font-size: 13.5px; color: var(--slate-700); line-height: 1.6; }
  .comment-input-area { margin-top: 16px; display: flex; gap: 8px; }
  .comment-textarea {
    flex: 1;
    padding: 10px 14px;
    border: 1.5px solid var(--slate-200);
    border-radius: 10px;
    font-size: 13.5px;
    resize: none;
    min-height: 80px;
    font-family: inherit;
    color: var(--slate-700);
  }
  .comment-textarea:focus { outline: none; border-color: var(--primary); }

  /* â”€â”€â”€ APPROVAL PANEL â”€â”€â”€ */
  .approval-panel { }
  .approval-status-large {
    text-align: center;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 16px;
  }
  .approval-icon { font-size: 36px; margin-bottom: 8px; }
  .approval-label { font-size: 16px; font-weight: 700; }
  .approval-desc { font-size: 12.5px; color: var(--slate-500); margin-top: 4px; }
  .action-buttons { display: flex; flex-direction: column; gap: 8px; }

  /* â”€â”€â”€ NEW CR FORM â”€â”€â”€ */
  .form-section { margin-bottom: 24px; }
  .form-section-title {
    font-size: 13px; font-weight: 700;
    color: var(--slate-500);
    text-transform: uppercase; letter-spacing: 0.06em;
    margin-bottom: 14px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--slate-200);
  }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-select {
    width: 100%;
    padding: 10px 14px;
    border: 1.5px solid var(--slate-200);
    border-radius: 8px;
    font-size: 14px;
    color: var(--slate-700);
    background: var(--slate-50);
    font-family: inherit;
  }
  .form-textarea {
    width: 100%;
    padding: 12px 14px;
    border: 1.5px solid var(--slate-200);
    border-radius: 8px;
    font-size: 14px;
    color: var(--slate-700);
    background: var(--slate-50);
    resize: vertical;
    min-height: 140px;
    font-family: inherit;
    line-height: 1.6;
  }
  .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--primary); background: var(--white); }
  .upload-zone {
    border: 2px dashed var(--slate-300);
    border-radius: 10px;
    padding: 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s;
    background: var(--slate-50);
  }
  .upload-zone:hover { border-color: var(--primary); background: var(--primary-light); }
  .upload-icon { font-size: 32px; margin-bottom: 8px; }
  .upload-title { font-size: 14px; font-weight: 600; color: var(--slate-700); margin-bottom: 4px; }
  .upload-desc { font-size: 12px; color: var(--slate-400); }
  .upload-files { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; }
  .upload-file-chip {
    display: inline-flex; align-items: center; gap: 6px;
    background: var(--white); border: 1px solid var(--slate-200);
    border-radius: 6px; padding: 5px 10px;
    font-size: 12px; color: var(--slate-700);
  }
  .pre-check-area { margin-top: 16px; }

  /* â”€â”€â”€ YAKKI-HO STANDALONE â”€â”€â”€ */
  .yakki-page { max-width: 860px; margin: 0 auto; }
  .yakki-input-area {
    background: var(--white);
    border: 1.5px solid var(--slate-200);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 16px;
  }
  .yakki-input {
    width: 100%;
    border: none;
    padding: 16px 20px;
    font-size: 14px;
    resize: none;
    min-height: 180px;
    font-family: inherit;
    color: var(--slate-700);
    line-height: 1.7;
  }
  .yakki-input:focus { outline: none; }
  .yakki-toolbar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 16px;
    background: var(--slate-50);
    border-top: 1px solid var(--slate-200);
  }
  .yakki-char-count { font-size: 12px; color: var(--slate-400); }
  .yakki-results { }
  .score-overview {
    display: grid; grid-template-columns: 200px 1fr; gap: 16px;
    margin-bottom: 20px;
  }
  .score-gauge {
    background: var(--white);
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
  }
  .score-circle {
    width: 100px; height: 100px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 12px;
    font-size: 28px; font-weight: 900;
    border: 6px solid;
  }
  .score-A { border-color: #059669; color: #059669; background: #ECFDF5; }
  .score-B { border-color: #2563EB; color: #2563EB; background: #EFF6FF; }
  .score-C { border-color: #D97706; color: #D97706; background: #FFFBEB; }
  .score-D { border-color: #DC2626; color: #DC2626; background: #FEF2F2; }
  .score-label { font-size: 13px; font-weight: 600; color: var(--slate-600); }
  .score-cats { display: flex; flex-direction: column; gap: 8px; justify-content: center; }
  .score-cat-row { display: flex; align-items: center; gap: 10px; }
  .score-cat-name { font-size: 12.5px; color: var(--slate-600); width: 160px; }
  .score-cat-bar { flex: 1; height: 8px; background: var(--slate-100); border-radius: 4px; overflow: hidden; }
  .score-cat-fill { height: 100%; border-radius: 4px; }
  .score-cat-val { font-size: 12px; font-weight: 700; width: 30px; text-align: right; }

  /* â”€â”€â”€ DASHBOARD RECENT â”€â”€â”€ */
  .dash-grid { display: grid; grid-template-columns: 1fr 320px; gap: 20px; }
  .recent-list { display: flex; flex-direction: column; }
  .recent-item {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 20px;
    border-bottom: 1px solid var(--slate-100);
    cursor: pointer;
    transition: background 0.1s;
  }
  .recent-item:hover { background: var(--slate-50); }
  .recent-item:last-child { border-bottom: none; }
  .recent-icon {
    width: 38px; height: 38px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 17px;
    flex-shrink: 0;
  }
  .recent-info { flex: 1; min-width: 0; }
  .recent-name { font-weight: 600; font-size: 13.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .recent-client { font-size: 12px; color: var(--slate-500); }
  .recent-date { font-size: 12px; color: var(--slate-400); flex-shrink: 0; }
  .activity-list { display: flex; flex-direction: column; gap: 12px; }
  .activity-item { display: flex; gap: 10px; align-items: flex-start; }
  .activity-dot {
    width: 8px; height: 8px; border-radius: 50%;
    flex-shrink: 0; margin-top: 5px;
  }
  .activity-text { font-size: 13px; color: var(--slate-600); line-height: 1.5; }
  .activity-time { font-size: 11.5px; color: var(--slate-400); margin-top: 2px; }

  /* â”€â”€â”€ MISC â”€â”€â”€ */
  .divider { height: 1px; background: var(--slate-200); margin: 16px 0; }
  .tag {
    display: inline-flex; align-items: center;
    background: var(--slate-100);
    border-radius: 6px;
    padding: 3px 8px;
    font-size: 12px;
    color: var(--slate-600);
    font-weight: 500;
  }
  .tag-blue { background: var(--primary-light); color: var(--primary); }
  .empty-state { text-align: center; padding: 60px 20px; color: var(--slate-400); }
  .empty-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-text { font-size: 15px; font-weight: 600; color: var(--slate-500); }
  .empty-sub { font-size: 13px; margin-top: 6px; }

  /* â”€â”€â”€ TOAST â”€â”€â”€ */
  #toast {
    position: fixed; bottom: 24px; right: 24px;
    background: var(--slate-800);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 13.5px;
    font-weight: 500;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 999;
    max-width: 340px;
  }
  #toast.show { transform: translateY(0); opacity: 1; }

  /* â”€â”€â”€ MODAL â”€â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(15,23,42,0.5);
    backdrop-filter: blur(2px);
    display: flex; align-items: center; justify-content: center;
    z-index: 200;
    display: none;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--white);
    border-radius: 16px;
    padding: 28px;
    width: 500px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    max-height: 90vh;
    overflow-y: auto;
  }
  .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
  .modal-desc { color: var(--slate-500); font-size: 13.5px; margin-bottom: 20px; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }

  /* â”€â”€â”€ SCROLLBAR â”€â”€â”€ */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--slate-300); border-radius: 3px; }

  /* â”€â”€â”€ ANIMATIONS â”€â”€â”€ */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .anim-in { animation: fadeInUp 0.25s ease forwards; }

  .progress-ring { display: inline-flex; position: relative; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-icon">CR</div>
      <div>
        <div class="login-logo-text">CR Manager</div>
        <div class="login-logo-sub">ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€å…ƒç®¡ç†</div>
      </div>
    </div>
    <div class="login-title">ãƒ­ã‚°ã‚¤ãƒ³</div>
    <div class="login-desc">å½¹å‰²ã‚’é¸æŠã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„</div>
    <div class="role-selector">
      <div class="role-btn active" onclick="selectRole('agency', this)">
        <div class="role-icon">ğŸ¢</div>
        <div class="role-name">ä»£ç†åº—</div>
        <div class="role-desc">CRæå‡ºãƒ»ä¿®æ­£</div>
      </div>
      <div class="role-btn" onclick="selectRole('client', this)">
        <div class="role-icon">ğŸ’„</div>
        <div class="role-name">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</div>
        <div class="role-desc">ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ‰¿èª</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
      <input class="form-input" type="email" id="loginEmail" value="agency@adpro.jp" placeholder="your@email.com">
    </div>
    <div class="form-group">
      <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input class="form-input" type="password" id="loginPass" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    </div>
    <button class="btn btn-primary" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP SHELL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="appShell">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">CR</div>
      <div>
        <div class="sidebar-logo-text">CR Manager</div>
        <div class="sidebar-logo-sub">v1.0 ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</div>
      </div>
    </div>
    <div class="sidebar-user">
      <div class="user-avatar" id="sidebarAvatar" style="background:#2563EB">A</div>
      <div>
        <div class="user-name" id="sidebarName">ç”°ä¸­ é›…äºº</div>
        <div class="user-role-badge badge-agency" id="sidebarBadge">ä»£ç†åº—</div>
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
      <div class="nav-item active" onclick="navigate('dashboard', this)">
        <span class="nav-icon">ğŸ“Š</span> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
      </div>
      <div class="nav-item" onclick="navigate('crlist', this)">
        <span class="nav-icon">ğŸ“‹</span> CRä¸€è¦§
        <span class="nav-badge" id="pendingBadge">3</span>
      </div>
      <div class="nav-item" id="navNewCR" onclick="navigate('newcr', this)">
        <span class="nav-icon">âœï¸</span> æ–°è¦CRä½œæˆ
      </div>
      <div class="nav-item" onclick="navigate('yakki', this)">
        <span class="nav-icon">âš–ï¸</span> è–¬æ©Ÿæ³•ãƒã‚§ãƒƒã‚«ãƒ¼
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">ç®¡ç†</div>
      <div class="nav-item" onclick="showToast('ã“ã®æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™')">
        <span class="nav-icon">ğŸ‘¥</span> ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
      </div>
      <div class="nav-item" onclick="showToast('ã“ã®æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™')">
        <span class="nav-icon">ğŸ·ï¸</span> ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç®¡ç†
      </div>
      <div class="nav-item" onclick="showToast('ã“ã®æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™')">
        <span class="nav-icon">ğŸ“ˆ</span> ãƒ¬ãƒãƒ¼ãƒˆ
      </div>
    </div>

    <div class="sidebar-bottom">
      <div class="nav-item" onclick="showToast('ã“ã®æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™')" style="margin-bottom:4px">
        <span class="nav-icon">âš™ï¸</span> è¨­å®š
      </div>
      <div class="logout-btn" onclick="doLogout()">
        <span>ğŸšª</span> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main-area">
    <!-- HEADER -->
    <div class="page-header">
      <div class="page-title" id="pageTitle">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
      <div class="page-header-actions" id="pageActions"></div>
    </div>

    <!-- PAGE CONTENT -->
    <div class="page-content">

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="view-dashboard" class="view active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">ç·CRæ•°</div>
            <div class="stat-value">24</div>
            <div class="stat-sub">ä»Šæœˆ +7ä»¶</div>
            <div class="stat-bar"><div class="stat-bar-fill" style="width:70%;background:var(--primary)"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡</div>
            <div class="stat-value" style="color:var(--warning)">3</div>
            <div class="stat-sub">å¹³å‡å¾…æ©Ÿ 2.1æ—¥</div>
            <div class="stat-bar"><div class="stat-bar-fill" style="width:30%;background:var(--warning)"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">æ‰¿èªæ¸ˆã¿</div>
            <div class="stat-value" style="color:var(--success)">18</div>
            <div class="stat-sub">æ‰¿èªç‡ 82%</div>
            <div class="stat-bar"><div class="stat-bar-fill" style="width:82%;background:var(--success)"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">è¦ä¿®æ­£</div>
            <div class="stat-value" style="color:var(--danger)">3</div>
            <div class="stat-sub">ä¿®æ­£ç‡ 18%</div>
            <div class="stat-bar"><div class="stat-bar-fill" style="width:18%;background:var(--danger)"></div></div>
          </div>
        </div>

        <div class="dash-grid">
          <div class="card">
            <div class="card-header">
              <div class="card-title">æœ€è¿‘ã®CR</div>
              <button class="btn btn-ghost btn-sm" onclick="navigate('crlist', document.querySelector('[onclick*=crlist]'))">ã™ã¹ã¦è¦‹ã‚‹</button>
            </div>
            <div id="recentCRList"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</div>
            </div>
            <div class="card-body">
              <div class="activity-list">
                <div class="activity-item">
                  <div class="activity-dot" style="background:var(--danger)"></div>
                  <div>
                    <div class="activity-text">ã€Œè‚Œè’ã‚Œä¿®å¾©ã‚¯ãƒªãƒ¼ãƒ  LPã€ã«è–¬æ©Ÿæ³•é•åã®ç–‘ã„ï¼ˆCriticalï¼‰ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ</div>
                    <div class="activity-time">10åˆ†å‰</div>
                  </div>
                </div>
                <div class="activity-item">
                  <div class="activity-dot" style="background:var(--success)"></div>
                  <div>
                    <div class="activity-text">ã€Œç¾ç™½ç¾å®¹æ¶² ãƒãƒŠãƒ¼ã€ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ</div>
                    <div class="activity-time">1æ™‚é–“å‰</div>
                  </div>
                </div>
                <div class="activity-item">
                  <div class="activity-dot" style="background:var(--primary)"></div>
                  <div>
                    <div class="activity-text">éˆ´æœ¨ã•ã‚“ãŒã€Œè‚²æ¯›å‰¤ LPï¼ˆãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ï¼‰ã€ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ</div>
                    <div class="activity-time">3æ™‚é–“å‰</div>
                  </div>
                </div>
                <div class="activity-item">
                  <div class="activity-dot" style="background:var(--warning)"></div>
                  <div>
                    <div class="activity-text">ã€Œæ—¥ç„¼ã‘æ­¢ã‚ SPF50+ ãƒãƒŠãƒ¼ã€ãŒè¦ä¿®æ­£ã¨ã—ã¦è¿”å´ã•ã‚Œã¾ã—ãŸ</div>
                    <div class="activity-time">æ˜¨æ—¥ 14:22</div>
                  </div>
                </div>
                <div class="activity-item">
                  <div class="activity-dot" style="background:var(--primary)"></div>
                  <div>
                    <div class="activity-text">æ–°è¦CRã€Œãƒ’ã‚¢ãƒ«ãƒ­ãƒ³é…¸ã‚µãƒ—ãƒª åºƒå‘Šæ–‡ã€ãŒæå‡ºã•ã‚Œã¾ã—ãŸ</div>
                    <div class="activity-time">æ˜¨æ—¥ 11:05</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ CR LIST â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="view-crlist" class="view">
        <div class="filter-bar">
          <input class="filter-input" type="text" placeholder="ğŸ” CRåãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã§æ¤œç´¢..." id="searchInput" oninput="filterCRs()">
          <select class="filter-select" id="statusFilter" onchange="filterCRs()">
            <option value="">ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
            <option value="draft">ä¸‹æ›¸ã</option>
            <option value="submitted">æå‡ºæ¸ˆã¿</option>
            <option value="reviewing">ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­</option>
            <option value="approved">æ‰¿èªæ¸ˆã¿</option>
            <option value="revision">è¦ä¿®æ­£</option>
            <option value="rejected">å´ä¸‹</option>
          </select>
          <select class="filter-select" id="categoryFilter" onchange="filterCRs()">
            <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
            <option value="åŒ–ç²§å“">åŒ–ç²§å“</option>
            <option value="åŒ»è–¬å“">åŒ»è–¬å“</option>
            <option value="åŒ»è–¬éƒ¨å¤–å“">åŒ»è–¬éƒ¨å¤–å“</option>
            <option value="ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ">ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ</option>
          </select>
          <button class="btn btn-ghost btn-sm" onclick="filterCRs()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div class="card">
          <table class="cr-table">
            <thead>
              <tr>
                <th>CR ID</th>
                <th>ã‚¿ã‚¤ãƒˆãƒ« / ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</th>
                <th>ã‚«ãƒ†ã‚´ãƒª</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th>è–¬æ©Ÿæ³•ãƒªã‚¹ã‚¯</th>
                <th>æå‡ºæ—¥</th>
                <th>æ‹…å½“è€…</th>
              </tr>
            </thead>
            <tbody id="crTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ CR DETAIL â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="view-detail" class="view">
        <div id="detailContent"></div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ NEW CR â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="view-newcr" class="view">
        <div style="max-width:780px">
          <div class="card">
            <div class="card-header">
              <div class="card-title">âœï¸ æ–°è¦CRä½œæˆ</div>
            </div>
            <div class="card-body">
              <div class="form-section">
                <div class="form-section-title">åŸºæœ¬æƒ…å ±</div>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">CR ã‚¿ã‚¤ãƒˆãƒ« <span style="color:var(--danger)">*</span></label>
                    <input class="form-input" type="text" id="newCRTitle" placeholder="ä¾‹ï¼šç¾ç™½ã‚¯ãƒªãƒ¼ãƒ  LP 2024å¹´æ˜¥ç‰ˆ">
                  </div>
                  <div class="form-group">
                    <label class="form-label">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå <span style="color:var(--danger)">*</span></label>
                    <input class="form-input" type="text" id="newCRClient" placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼ã‚³ã‚¹ãƒ¡">
                  </div>
                  <div class="form-group">
                    <label class="form-label">å•†å“ã‚«ãƒ†ã‚´ãƒª <span style="color:var(--danger)">*</span></label>
                    <select class="form-select" id="newCRCategory">
                      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                      <option value="åŒ–ç²§å“">åŒ–ç²§å“</option>
                      <option value="åŒ»è–¬å“">åŒ»è–¬å“</option>
                      <option value="åŒ»è–¬éƒ¨å¤–å“">åŒ»è–¬éƒ¨å¤–å“</option>
                      <option value="ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ">ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ</option>
                      <option value="å¥åº·é£Ÿå“">å¥åº·é£Ÿå“</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">ç´ æã‚¿ã‚¤ãƒ— <span style="color:var(--danger)">*</span></label>
                    <select class="form-select" id="newCRType">
                      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                      <option value="LP">LPï¼ˆãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ï¼‰</option>
                      <option value="ãƒãƒŠãƒ¼">ãƒãƒŠãƒ¼åºƒå‘Š</option>
                      <option value="SNS">SNSæŠ•ç¨¿</option>
                      <option value="å‹•ç”»">å‹•ç”»ã‚¹ã‚¯ãƒªãƒ—ãƒˆ</option>
                      <option value="ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆ">ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆ</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">å¸Œæœ›ãƒ¬ãƒ“ãƒ¥ãƒ¼æœŸé™</label>
                    <input class="form-input" type="date" id="newCRDeadline">
                  </div>
                  <div class="form-group">
                    <label class="form-label">å„ªå…ˆåº¦</label>
                    <select class="form-select" id="newCRPriority">
                      <option value="normal">é€šå¸¸</option>
                      <option value="high">é«˜ï¼ˆæ€¥ãï¼‰</option>
                      <option value="urgent">è‡³æ€¥</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="form-section">
                <div class="form-section-title">ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼</div>
                <div class="form-group">
                  <label class="form-label">åºƒå‘Šæ–‡ãƒ»ã‚³ãƒ”ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ</label>
                  <textarea class="form-textarea" id="newCRCopy" rows="8"
                    placeholder="ãƒã‚§ãƒƒã‚¯ã—ãŸã„åºƒå‘Šæ–‡ã‚„ã‚³ãƒ”ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚è–¬æ©Ÿæ³•AIãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å•é¡Œç®‡æ‰€ã‚’æ¤œå‡ºã—ã¾ã™ã€‚"></textarea>
                </div>
                <button class="btn btn-purple btn-sm" onclick="preCheckCopy()">
                  âš¡ äº‹å‰ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
                </button>
                <div id="preCheckResult" class="pre-check-area"></div>
              </div>

              <div class="form-section">
                <div class="form-section-title">ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜</div>
                <div class="upload-zone" onclick="simulateUpload()">
                  <div class="upload-icon">ğŸ“</div>
                  <div class="upload-title">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
                  <div class="upload-desc">å¯¾å¿œå½¢å¼ï¼šJPG, PNG, MP4, PDFï¼ˆæœ€å¤§100MBï¼‰</div>
                  <div class="upload-files" id="uploadedFiles"></div>
                </div>
              </div>

              <div class="form-section">
                <div class="form-section-title">å‚™è€ƒãƒ»ä¾é ¼äº‹é …</div>
                <textarea class="form-textarea" id="newCRNote" rows="4"
                  placeholder="ç¢ºèªã—ã¦ã»ã—ã„ãƒã‚¤ãƒ³ãƒˆã‚„ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
              </div>

              <div style="display:flex;gap:10px;justify-content:flex-end">
                <button class="btn btn-ghost" onclick="navigate('dashboard', document.querySelector('[onclick*=dashboard]'))">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-ghost" onclick="saveDraft()">ä¸‹æ›¸ãä¿å­˜</button>
                <button class="btn btn-primary" onclick="submitCR()">ğŸ“¤ CRã‚’æå‡ºã™ã‚‹</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ YAKKI-HO CHECKER â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="view-yakki" class="view">
        <div class="yakki-page">
          <div style="margin-bottom:20px">
            <div style="font-size:16px;font-weight:700;color:var(--slate-700);margin-bottom:6px">âš–ï¸ è–¬æ©Ÿæ³• AIãƒã‚§ãƒƒã‚«ãƒ¼</div>
            <div style="color:var(--slate-500);font-size:13.5px">åºƒå‘Šæ–‡ãƒ»ã‚³ãƒ”ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€è–¬æ©Ÿæ³•ï¼ˆåŒ»è–¬å“åŒ»ç™‚æ©Ÿå™¨ç­‰æ³•ï¼‰ã®è¦³ç‚¹ã‹ã‚‰å•é¡Œã®ã‚ã‚‹è¡¨ç¾ã‚’AIãŒè‡ªå‹•æ¤œå‡ºã—ã¾ã™ã€‚</div>
          </div>
          <div class="yakki-input-area">
            <textarea class="yakki-input" id="yakkiInput"
              placeholder="ãƒã‚§ãƒƒã‚¯ã—ãŸã„åºƒå‘Šæ–‡ãƒ»ã‚³ãƒ”ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...&#10;&#10;ä¾‹ï¼šã€Œã“ã®ã‚¯ãƒªãƒ¼ãƒ ã‚’ä½¿ãˆã°ã€ã‚·ãƒŸãŒçµ¶å¯¾ã«æ¶ˆãˆã¾ã™ã€‚è‚Œã‚’å†ç”Ÿã—ã€è€åŒ–ã‚’æ²»ç™‚ã™ã‚‹å¥‡è·¡ã®ç¾å®¹æ¶²ï¼ã€"></textarea>
            <div class="yakki-toolbar">
              <div style="display:flex;gap:8px">
                <button class="btn btn-ghost btn-xs" onclick="loadSample(1)">ã‚µãƒ³ãƒ—ãƒ«1ï¼ˆåŒ–ç²§å“ï¼‰</button>
                <button class="btn btn-ghost btn-xs" onclick="loadSample(2)">ã‚µãƒ³ãƒ—ãƒ«2ï¼ˆåŒ»è–¬éƒ¨å¤–å“ï¼‰</button>
                <button class="btn btn-ghost btn-xs" onclick="document.getElementById('yakkiInput').value='';document.getElementById('yakkiResults').innerHTML=''">ã‚¯ãƒªã‚¢</button>
              </div>
              <div style="display:flex;align-items:center;gap:12px">
                <span class="yakki-char-count" id="charCount">0æ–‡å­—</span>
                <button class="btn btn-purple" onclick="runYakkiCheck()">âš¡ ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ</button>
              </div>
            </div>
          </div>
          <div id="yakkiResults"></div>
        </div>
      </div>

    </div><!-- /page-content -->
  </div><!-- /main-area -->
</div><!-- /appShell -->

<!-- TOAST -->
<div id="toast"></div>

<!-- APPROVAL MODAL -->
<div class="modal-overlay" id="approvalModal">
  <div class="modal">
    <div class="modal-title" id="modalTitle">CRã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ</div>
    <div class="modal-desc" id="modalDesc">æ‰¿èªã™ã‚‹ã¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ã‚·ãƒ¼ã«é€šçŸ¥ãŒé€ã‚‰ã‚Œã¾ã™ã€‚</div>
    <div class="form-group">
      <label class="form-label">ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
      <textarea class="comment-textarea" id="modalComment" rows="3" placeholder="æ‰¿èªã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn" id="modalConfirmBtn" onclick="confirmAction()">ç¢ºèª</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = { role: 'agency', name: 'ç”°ä¸­ é›…äºº', email: 'agency@adpro.jp', company: 'ADãƒ—ãƒ­æ ªå¼ä¼šç¤¾' };
let selectedRole = 'agency';
let currentView = 'dashboard';
let currentCRId = null;
let pendingActionType = null;

const MOCK_CRS = [
  {
    id: 'CR-2024-024',
    title: 'è‚Œè’ã‚Œä¿®å¾©ã‚¯ãƒªãƒ¼ãƒ  LP',
    client: 'æ ªå¼ä¼šç¤¾ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£',
    category: 'åŒ»è–¬éƒ¨å¤–å“',
    type: 'LP',
    status: 'submitted',
    riskLevel: 'critical',
    submittedDate: '2024-01-24',
    deadline: '2024-01-27',
    assignee: 'å±±ç”° èŠ±å­',
    priority: 'urgent',
    copy: `ã“ã®è‚Œè’ã‚Œä¿®å¾©ã‚¯ãƒªãƒ¼ãƒ ã¯ã€è’ã‚ŒãŸè‚Œã‚’å®Œå…¨ã«æ²»ç™‚ã—ã¾ã™ã€‚
ãŸã£ãŸ7æ—¥é–“ã§ç´°èƒã‚’å†ç”Ÿãƒ»æ´»æ€§åŒ–ã—ã€é©šç•°çš„ãªå›å¾©åŠ›ã§è‚Œãƒˆãƒ©ãƒ–ãƒ«ã‚’æ ¹æœ¬ã‹ã‚‰æ²»ã™å¥‡è·¡ã®ã‚¯ãƒªãƒ¼ãƒ ã€‚

çµ¶å¯¾ã«åŠ¹æœã‚’å®Ÿæ„Ÿã§ãã‚‹ç¾è‚Œæˆåˆ†ã‚’å‡ç¸®ï¼
ä»–ç¤¾è£½å“ã¨æ¯”ã¹ã¦3å€ã®æœ‰åŠ¹æˆåˆ†ã‚’é…åˆã€‚æ¥­ç•ŒNo.1ã®æµ¸é€åŠ›ã§ã€è‚Œå¥¥æ·±ãã¾ã§ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«å±Šãã¾ã™ã€‚

çš®è†šç§‘åŒ»ã‚‚èªã‚ãŸï¼ˆâ€»å€‹äººã®æ„Ÿæƒ³ã§ã™ï¼‰ã“ã®å‡¦æ–¹ã§ã€è€åŒ–ã—ãŸè‚Œã‚’è‹¥è¿”ã‚‰ã›ã¾ã—ã‚‡ã†ã€‚
ã‚·ãƒŸãƒ»ã‚·ãƒ¯ãƒ»ãƒ‹ã‚­ãƒ“è·¡ã‚’å®Œç’§ã«æ¶ˆå»ã—ã€20ä»£ã®ã‚ˆã†ãªè‚Œã‚’å–ã‚Šæˆ»ã›ã¾ã™ã€‚`,
    files: [{ name: 'LP_design_v3.pdf', type: 'PDF', size: '4.2MB' }],
    comments: [
      { author: 'å±±ç”° èŠ±å­', role: 'client', time: '30åˆ†å‰', text: 'ã€Œæ²»ç™‚ã€ã€Œç´°èƒå†ç”Ÿã€ã¨ã„ã†è¡¨ç¾ã¯è–¬æ©Ÿæ³•ä¸Šå•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚é€Ÿã‚„ã‹ã«ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚' },
      { author: 'ç”°ä¸­ é›…äºº', role: 'agency', time: '25åˆ†å‰', text: 'ç¢ºèªã—ã¾ã—ãŸã€‚ä¿®æ­£æ¡ˆã‚’ä½œæˆä¸­ã§ã™ã€‚' },
    ]
  },
  {
    id: 'CR-2024-023',
    title: 'ç¾ç™½ç¾å®¹æ¶² ãƒãƒŠãƒ¼åºƒå‘Šã‚»ãƒƒãƒˆ',
    client: 'æ ªå¼ä¼šç¤¾ã‚³ã‚¹ãƒ¡ãƒ–ãƒ©ãƒ³ãƒ‰',
    category: 'åŒ–ç²§å“',
    type: 'ãƒãƒŠãƒ¼',
    status: 'approved',
    riskLevel: 'low',
    submittedDate: '2024-01-22',
    deadline: '2024-01-25',
    assignee: 'éˆ´æœ¨ ä¸€éƒ',
    priority: 'normal',
    copy: `ã€æ–°ç™»å ´ã€‘ãƒ“ã‚¿ãƒŸãƒ³Cç¾ç™½ç¾å®¹æ¶²
ã¿ãšã¿ãšã—ã„è‚Œã¸å°ãã€ã†ã‚‹ãŠã„ã‚±ã‚¢ã€‚
æ¯æ—¥ã®ã‚¹ã‚­ãƒ³ã‚±ã‚¢ã§ã€ãƒãƒªã®ã‚ã‚‹æ˜ã‚‹ã„è‚Œå°è±¡ã¸ã€‚
â€»åŠ¹æœã«ã¯å€‹äººå·®ãŒã‚ã‚Šã¾ã™ã€‚`,
    files: [
      { name: 'banner_300x250.jpg', type: 'JPG', size: '245KB' },
      { name: 'banner_728x90.jpg', type: 'JPG', size: '189KB' },
    ],
    comments: [
      { author: 'éˆ´æœ¨ ä¸€éƒ', role: 'client', time: '1æ—¥å‰', text: 'ã‚³ãƒ”ãƒ¼å…¨ä½“çš„ã«å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚æ‰¿èªã—ã¾ã™ã€‚' }
    ]
  },
  {
    id: 'CR-2024-022',
    title: 'æ—¥ç„¼ã‘æ­¢ã‚ SPF50+ ãƒãƒŠãƒ¼',
    client: 'æ ªå¼ä¼šç¤¾ã‚µãƒ³ã‚±ã‚¢',
    category: 'åŒ–ç²§å“',
    type: 'ãƒãƒŠãƒ¼',
    status: 'revision',
    riskLevel: 'medium',
    submittedDate: '2024-01-20',
    deadline: '2024-01-23',
    assignee: 'ä½è—¤ ç¾å’²',
    priority: 'high',
    copy: `æœ€å¼·ã®ç´«å¤–ç·šãƒ–ãƒ­ãƒƒã‚¯ï¼SPF50+ PA++++
æ—¥æœ¬æœ€é«˜å³°ã®ç´«å¤–ç·šã‚«ãƒƒãƒˆç‡ã‚’èª‡ã‚‹æ—¥ç„¼ã‘æ­¢ã‚ã€‚
å¡—ã‚Œã°ç¢ºå®Ÿã«UVãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã‚·ãƒ£ãƒƒãƒˆã‚¢ã‚¦ãƒˆï¼
æ±—ãƒ»æ°´ã«å¼·ã„å‡¦æ–¹ã§ã€ä¸€æ—¥ä¸­å®Œç’§ãªè‚Œã‚’å®ˆã‚Šã¾ã™ã€‚`,
    files: [
      { name: 'suncare_banner.png', type: 'PNG', size: '312KB' },
    ],
    comments: [
      { author: 'ä½è—¤ ç¾å’²', role: 'client', time: '2æ—¥å‰', text: 'ã€Œæœ€å¼·ã€ã€Œç¢ºå®Ÿã«ã€ã€Œå®Œç’§ãªã€ã¨ã„ã†è¡¨ç¾ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚æ ¹æ‹ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°æ·»ä»˜è³‡æ–™ã‚‚æå‡ºã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚' }
    ]
  },
  {
    id: 'CR-2024-021',
    title: 'è‚²æ¯›å‰¤ LPï¼ˆãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ï¼‰',
    client: 'æ ªå¼ä¼šç¤¾ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ãƒ—ãƒ­',
    category: 'åŒ»è–¬éƒ¨å¤–å“',
    type: 'LP',
    status: 'reviewing',
    riskLevel: 'high',
    submittedDate: '2024-01-18',
    deadline: '2024-01-26',
    assignee: 'é«˜æ©‹ å¥å¤ª',
    priority: 'high',
    copy: `åŒ»è–¬éƒ¨å¤–å“ è‚²æ¯›å‰¤ã€ŒRe:Growthã€ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«

ç™ºæ¯›ã‚’ä¿ƒé€²ï¼è–„æ¯›ãƒ»è„±æ¯›ã®ãŠæ‚©ã¿ã«ã€‚
æœ‰åŠ¹æˆåˆ†ãƒŸãƒã‚­ã‚·ã‚¸ãƒ«é…åˆã§ã€é ­çš®ç’°å¢ƒã‚’æ”¹å–„ã€‚

æ¥­ç•ŒNo.1ï¼ˆâ€»2023å¹´è‡ªç¤¾èª¿ã¹ï¼‰ã®è‚²æ¯›æˆåˆ†é…åˆé‡ã‚’èª‡ã‚‹ã€æ¬¡ä¸–ä»£è‚²æ¯›å‰¤ãŒæ–°ç™»å ´ã€‚
ä½¿ã„ç¶šã‘ã‚Œã°å¿…ãšåŠ¹æœã‚’å®Ÿæ„Ÿã§ãã¾ã™ã€‚

1000äººã«èª¿æŸ»ã—ãŸçµæœã€95%ãŒæº€è¶³ã¨å›ç­”ï¼ï¼ˆâ€»å€‹äººã®æ„Ÿæƒ³ã§ã‚ã‚Šã€åŠ¹æœã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰`,
    files: [
      { name: 'LP_hairgrowth_draft.pdf', type: 'PDF', size: '6.8MB' },
      { name: 'ingredient_data.xlsx', type: 'XLSX', size: '245KB' }
    ],
    comments: [
      { author: 'é«˜æ©‹ å¥å¤ª', role: 'client', time: '6æ™‚é–“å‰', text: 'ã€Œå¿…ãšåŠ¹æœã‚’å®Ÿæ„Ÿã€ã¨ã„ã†è¡¨ç¾ã¯è¦ä¿®æ­£ã§ã™ã€‚ã¾ãŸã€No.1è¡¨ç¾ã®æ ¹æ‹ ãƒ‡ãƒ¼ã‚¿ã®æç¤ºã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚' },
      { author: 'ç”°ä¸­ é›…äºº', role: 'agency', time: '5æ™‚é–“å‰', text: 'æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚æ ¹æ‹ ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ä¸­ã§ã™ã€‚' }
    ]
  },
  {
    id: 'CR-2024-020',
    title: 'ãƒ’ã‚¢ãƒ«ãƒ­ãƒ³é…¸ã‚µãƒ—ãƒª åºƒå‘Šæ–‡',
    client: 'æ ªå¼ä¼šç¤¾ãƒ˜ãƒ«ã‚·ãƒ¼ãƒ©ã‚¤ãƒ•',
    category: 'ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ',
    type: 'SNS',
    status: 'draft',
    riskLevel: 'none',
    submittedDate: '2024-01-24',
    deadline: '2024-01-30',
    assignee: 'â€”',
    priority: 'normal',
    copy: `æ¯æ—¥ã®ã†ã‚‹ãŠã„ã‚±ã‚¢ã«ã€‚ãƒ’ã‚¢ãƒ«ãƒ­ãƒ³é…¸ã‚µãƒ—ãƒªæ–°ç™ºå£²ï¼
é£²ã‚€ã‚¹ã‚­ãƒ³ã‚±ã‚¢ã§ã€ä½“ã®å†…å´ã‹ã‚‰ã†ã‚‹ãŠã„ãƒãƒ£ãƒ¼ã‚¸ã€‚
â€»æœ¬å“ã¯æ „é¤Šè£œåŠ©é£Ÿå“ã§ã‚ã‚Šã€ç–¾ç—…ã®è¨ºæ–­ãƒ»æ²»ç™‚ã‚’ç›®çš„ã¨ã—ãŸã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`,
    files: [],
    comments: []
  },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  YAKKI-HO RULES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const YAKKI_RULES = [
  {
    category: 'åŒ»è–¬å“çš„åŠ¹èƒ½ã®æ¨™æ¦œï¼ˆæœ€é‡è¦ï¼‰',
    severity: 'critical',
    icon: 'ğŸš¨',
    patterns: [
      { regex: /æ²»ç™‚|æ²»ã‚‹|æ²»ã™/g, keyword: 'æ²»ç™‚/æ²»ã‚‹/æ²»ã™', reason: 'ç–¾ç—…ã®ã€Œæ²»ç™‚ã€åŠ¹æœã¯åŒ»è–¬å“ã«ã®ã¿è¨±å¯ã•ã‚ŒãŸåŠ¹èƒ½ã§ã™ã€‚åŒ–ç²§å“ãƒ»åŒ»è–¬éƒ¨å¤–å“ã§ã¯ä½¿ç”¨ä¸å¯ã€‚', suggestion: 'ã€Œã‚±ã‚¢ã™ã‚‹ã€ã€Œæ•´ãˆã‚‹ã€ã€Œã‚µãƒãƒ¼ãƒˆã™ã‚‹ã€ç­‰ã®è¡¨ç¾ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚' },
      { regex: /ç´°èƒ(ã‚’)?(å†ç”Ÿ|æ´»æ€§åŒ–|ä¿®å¾©)/g, keyword: 'ç´°èƒå†ç”Ÿ/æ´»æ€§åŒ–', reason: 'ã€Œç´°èƒã€ã¸ã®ç›´æ¥ä½œç”¨ã‚’ç¤ºã™è¡¨ç¾ã¯åŒ»è–¬å“çš„åŠ¹èƒ½ã«ã‚ãŸã‚Šã¾ã™ã€‚', suggestion: 'ã€Œè‚Œã®ã‚¿ãƒ¼ãƒ³ã‚ªãƒ¼ãƒãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã€ã€Œè‚Œã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚’æ•´ãˆã‚‹ã€ç­‰ã«å¤‰æ›´ã€‚' },
      { regex: /è‚Œ(ã‚’)?(å†ç”Ÿ|ä¿®å¾©)/g, keyword: 'è‚Œå†ç”Ÿ/ä¿®å¾©', reason: 'çš®è†šã®ã€Œå†ç”Ÿãƒ»ä¿®å¾©ã€ã¯åŒ»è–¬å“çš„åŠ¹èƒ½ã¨ã—ã¦å•é¡Œã«ãªã‚Šã¾ã™ã€‚', suggestion: 'ã€Œè‚Œã‚’æ•´ãˆã‚‹ã€ã€Œã†ã‚‹ãŠã„ã‚’ä¸ãˆã‚‹ã€ç­‰ã®è¡¨ç¾ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚' },
      { regex: /è€åŒ–(ã‚’)?(æ²»|é˜²æ­¢|é£Ÿã„æ­¢ã‚)/g, keyword: 'è€åŒ–ã‚’æ²»/é˜²æ­¢', reason: 'ã€Œè€åŒ–é˜²æ­¢ã€ã‚’è¬³ã†è¡¨ç¾ã¯åŒ–ç²§å“ã§ã¯èªã‚ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', suggestion: 'ã€Œã‚¨ã‚¤ã‚¸ãƒ³ã‚°ã‚±ã‚¢ï¼ˆå¹´é½¢ã«å¿œã˜ãŸãŠæ‰‹å…¥ã‚Œï¼‰ã¨ã—ã¦ã€ç­‰ã®è¡¨ç¾ã«ã€‚' },
      { regex: /ã‚¦ã‚¤ãƒ«ã‚¹(ã‚’)?(é˜²|é™¤å»|æ®º)/g, keyword: 'ã‚¦ã‚¤ãƒ«ã‚¹é™¤å»ç­‰', reason: 'ã‚¦ã‚¤ãƒ«ã‚¹ã¸ã®åŠ¹æœã¯åŒ»è–¬å“çš„åŠ¹èƒ½ã«ã‚ãŸã‚Šã¾ã™ã€‚', suggestion: 'å…·ä½“çš„ãªã‚¦ã‚¤ãƒ«ã‚¹åãƒ»æŠ—èŒãƒ»æŠ—ã‚¦ã‚¤ãƒ«ã‚¹åŠ¹æœã®è¡¨ç¾ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚' },
    ]
  },
  {
    category: 'èª‡å¤§åºƒå‘Šãƒ»çµ¶å¯¾çš„è¡¨ç¾',
    severity: 'high',
    icon: 'âš ï¸',
    patterns: [
      { regex: /çµ¶å¯¾(ã«)?/g, keyword: 'çµ¶å¯¾ã«', reason: 'ã€Œçµ¶å¯¾ã€ã¯åŠ¹æœãƒ»å“è³ªã‚’æ–­å®šã™ã‚‹èª‡å¤§è¡¨ç¾ã§ã™ã€‚å€‹äººå·®ãŒã‚ã‚‹åŠ¹æœã‚’æ–­è¨€ã—ã¦ã¯ãªã‚Šã¾ã›ã‚“ã€‚', suggestion: 'ã€Œå®Ÿæ„Ÿã—ã‚„ã™ã„ã€ã€Œå¤šãã®æ–¹ã«ã€ç­‰ã®è¡¨ç¾ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚' },
      { regex: /å¿…ãš(åŠ¹æœ)?/g, keyword: 'å¿…ãš', reason: 'ã€Œå¿…ãšã€ã¯åŠ¹æœã‚’ä¿è¨¼ã™ã‚‹è¡¨ç¾ã¨ã—ã¦è–¬æ©Ÿæ³•ä¸Šå•é¡Œã§ã™ã€‚', suggestion: 'ã€Œå¤šãã®æ–¹ã«ã”æº€è¶³ã„ãŸã ã„ã¦ã„ã¾ã™ã€ç­‰ã«å¤‰æ›´ã€‚' },
      { regex: /å¥‡è·¡(ã®|çš„|ã®)/g, keyword: 'å¥‡è·¡', reason: 'ã€Œå¥‡è·¡ã€ã¯ç§‘å­¦çš„æ ¹æ‹ ã®ãªã„èª‡å¤§è¡¨ç¾ã§ã™ã€‚', suggestion: 'è¡¨ç¾ã‚’å‰Šé™¤ã—ã€å…·ä½“çš„ãªæˆåˆ†ãƒ»åŠ¹æœã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚' },
      { regex: /é©šç•°çš„(ãª)?/g, keyword: 'é©šç•°çš„', reason: 'ã€Œé©šç•°çš„ã€ã¯èª‡å¤§ãªå“è³ªè¡¨ç¾ã¨ã—ã¦å•é¡Œã«ãªã‚Šã¾ã™ã€‚', suggestion: 'ã€Œé«˜ã„ã€ã€Œå„ªã‚ŒãŸã€ç­‰ã®å…·ä½“çš„ã‹ã¤æ ¹æ‹ ã‚ã‚‹è¡¨ç¾ã«å¤‰æ›´ã€‚' },
      { regex: /å®Œç’§(ã«|ãª)/g, keyword: 'å®Œç’§', reason: 'ã€Œå®Œç’§ã€ã¯éåº¦ãªå“è³ªå¼·èª¿ã¨ã—ã¦æŒ‡æ‘˜ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', suggestion: 'ã€Œã—ã£ã‹ã‚Šã¨ã€ã€Œé«˜ã„åŠ¹æœã§ã€ç­‰ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚' },
    ]
  },
  {
    category: 'æœ€ä¸Šç´šãƒ»No.1è¡¨ç¾',
    severity: 'medium',
    icon: 'ğŸ“Š',
    patterns: [
      { regex: /No\.?1|ãƒŠãƒ³ãƒãƒ¼ãƒ¯ãƒ³|â„–1/g, keyword: 'No.1è¡¨ç¾', reason: 'No.1è¡¨ç¾ã«ã¯å®¢è¦³çš„ãªèª¿æŸ»æ ¹æ‹ ã¨å‡ºå…¸ã®æ˜ç¤ºãŒå¿…è¦ã§ã™ã€‚', suggestion: 'ã€ŒNo.1ï¼ˆâ—‹â—‹èª¿ã¹ã€å¯¾è±¡ï¼šâ—‹â—‹ã€n=â—‹â—‹ã€èª¿æŸ»æœŸé–“ï¼šâ—‹â—‹ï¼‰ã€ç­‰ã®å½¢å¼ã§æ ¹æ‹ ã‚’æ˜ç¤ºã—ã¦ãã ã•ã„ã€‚' },
      { regex: /æœ€å¼·(ã®)?/g, keyword: 'æœ€å¼·', reason: 'ã€Œæœ€å¼·ã€ã¯æ ¹æ‹ ã®ãªã„æœ€ä¸Šç´šè¡¨ç¾ã¨ã—ã¦å•é¡Œã«ãªã‚Šã¾ã™ã€‚', suggestion: 'ã€Œé«˜ã„â—‹â—‹åŠ›ã‚’å®Ÿç¾ã€ç­‰ã€å…·ä½“çš„ãªç‰¹é•·ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚' },
      { regex: /æœ€é«˜å³°/g, keyword: 'æœ€é«˜å³°', reason: 'æ ¹æ‹ ã®ãªã„æœ€ä¸Šç´šè¡¨ç¾ã§ã™ã€‚å®¢è¦³çš„ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™ã€‚', suggestion: 'ã€Œâ—‹â—‹ã®æŠ€è¡“ã‚’æ¡ç”¨ã—ãŸã€ç­‰ã€å…·ä½“çš„ãªç‰¹å¾´ã«å¤‰æ›´ã€‚' },
      { regex: /æ¥­ç•Œåˆ/g, keyword: 'æ¥­ç•Œåˆ', reason: 'ã€Œæ¥­ç•Œåˆã€ã¯äº‹å®Ÿç¢ºèªã¨æ ¹æ‹ ã®æ˜ç¤ºãŒå¿…è¦ã§ã™ã€‚', suggestion: 'ã€Œå½“ç¤¾åˆï¼ˆâ—‹â—‹å¹´èª¿ã¹ï¼‰ã€ç­‰ã€å…·ä½“çš„ãªç¯„å›²ã¨æ ¹æ‹ ã‚’æ˜ç¤ºã—ã¦ãã ã•ã„ã€‚' },
    ]
  },
  {
    category: 'è‹¥è¿”ã‚Šãƒ»ã‚¢ãƒ³ãƒã‚¨ã‚¤ã‚¸ãƒ³ã‚°è¡¨ç¾',
    severity: 'medium',
    icon: 'â°',
    patterns: [
      { regex: /è‹¥è¿”/g, keyword: 'è‹¥è¿”ã‚Š', reason: 'ã€Œè‹¥è¿”ã‚Šã€ã¯åŒ»è–¬å“çš„åŠ¹èƒ½ï¼ˆæ™‚è¨ˆã‚’é€†è¡Œã•ã›ã‚‹ï¼‰ã¨è§£é‡ˆã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', suggestion: 'ã€Œãƒãƒªã®ã‚ã‚‹è‚Œã«ã€ã€Œæ˜ã‚‹ã„è‚Œå°è±¡ã«ã€ç­‰ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚' },
      { regex: /ã‚¢ãƒ³ãƒã‚¨ã‚¤ã‚¸ãƒ³ã‚°/gi, keyword: 'ã‚¢ãƒ³ãƒã‚¨ã‚¤ã‚¸ãƒ³ã‚°', reason: 'ã€Œã‚¢ãƒ³ãƒã‚¨ã‚¤ã‚¸ãƒ³ã‚°ã€ã¯æ–‡è„ˆã«ã‚ˆã£ã¦ã¯åŒ»è–¬å“çš„åŠ¹èƒ½ã¨ã—ã¦å•é¡Œã«ãªã‚Šã¾ã™ã€‚', suggestion: 'ã€Œã‚¨ã‚¤ã‚¸ãƒ³ã‚°ã‚±ã‚¢ï¼ˆå¹´é½¢ã«å¿œã˜ãŸãŠæ‰‹å…¥ã‚Œï¼‰ã€ã¨ã„ã†è¡¨ç¾ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚' },
      { regex: /ã‚·ãƒŸ.{0,6}(æ¶ˆ|å–|é™¤)/g, keyword: 'ã‚·ãƒŸã‚’æ¶ˆã™ç­‰', reason: 'åŒ–ç²§å“ã§ã‚·ãƒŸã®ã€Œæ¶ˆå»ãƒ»é™¤å»ã€ã‚’è¬³ã†ã“ã¨ã¯èªã‚ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆåŒ»è–¬éƒ¨å¤–å“ã®æ‰¿èªåŠ¹èƒ½ç¯„å›²å†…ã«é™å®šï¼‰ã€‚', suggestion: 'åŒ–ç²§å“ã®å ´åˆã¯ã€Œã‚·ãƒŸã‚’ç›®ç«‹ã¡ã«ããã™ã‚‹ã€ç­‰ã®è¡¨ç¾ã«ã€‚åŒ»è–¬éƒ¨å¤–å“ã®æ‰¿èªåŠ¹èƒ½ã«å¾“ã£ã¦ãã ã•ã„ã€‚' },
    ]
  },
  {
    category: 'æ ¹æ‹ ãªãæ¯”è¼ƒãƒ»ä½“é¨“è«‡',
    severity: 'low',
    icon: 'ğŸ’¬',
    patterns: [
      { regex: /ä»–ç¤¾(æ¯”|è£½å“ã‚ˆã‚Š|ã‚ˆã‚Š)/g, keyword: 'ä»–ç¤¾æ¯”', reason: 'æ¯”è¼ƒåºƒå‘Šã«ã¯å®¢è¦³çš„ãªè©¦é¨“ãƒ‡ãƒ¼ã‚¿ã¨æ¯”è¼ƒæ¡ä»¶ã®æ˜ç¤ºãŒå¿…è¦ã§ã™ã€‚', suggestion: 'ã€Œå¾“æ¥å“ï¼ˆå½“ç¤¾è£½å“åï¼‰ã¨ã®æ¯”è¼ƒï¼ˆè©¦é¨“æ¡ä»¶ï¼šâ—‹â—‹ï¼‰ã€ç­‰ã€æ ¹æ‹ ã‚’æ˜ç¤ºã—ã¦ãã ã•ã„ã€‚' },
      { regex: /\d+å€(ã®åŠ¹æœ)?/g, keyword: 'â—‹â—‹å€è¡¨ç¾', reason: 'å€ç‡ã®è¡¨ç¾ã«ã¯æ ¹æ‹ ã¨ãªã‚‹æ¯”è¼ƒè©¦é¨“ãƒ‡ãƒ¼ã‚¿ã®é–‹ç¤ºãŒå¿…è¦ã§ã™ã€‚', suggestion: 'ã€Œâ—‹â—‹æ¯”è¼ƒè©¦é¨“ï¼ˆn=â—‹â—‹ï¼‰ã§â–³â–³å€ã®å¸åç‡ã‚’ç¢ºèªã€ç­‰ã®å½¢å¼ã§å‡ºå…¸ã‚’æ˜ç¤ºã€‚' },
    ]
  },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHECK ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runCheck(text) {
  const results = [];
  YAKKI_RULES.forEach(rule => {
    rule.patterns.forEach(p => {
      const regex = new RegExp(p.regex.source, 'g');
      let match;
      const matches = [];
      while ((match = regex.exec(text)) !== null) {
        const start = Math.max(0, match.index - 20);
        const end = Math.min(text.length, match.index + match[0].length + 20);
        const context = text.substring(start, end);
        matches.push({ matched: match[0], context });
      }
      if (matches.length > 0) {
        results.push({
          category: rule.category,
          severity: rule.severity,
          icon: rule.icon,
          keyword: p.keyword,
          reason: p.reason,
          suggestion: p.suggestion,
          matches,
        });
      }
    });
  });
  return results;
}

function getRiskLevel(results) {
  if (results.some(r => r.severity === 'critical')) return 'critical';
  if (results.some(r => r.severity === 'high')) return 'high';
  if (results.some(r => r.severity === 'medium')) return 'medium';
  if (results.some(r => r.severity === 'low')) return 'low';
  return 'none';
}

function getRiskLabel(level) {
  const map = { critical: 'Critical', high: 'é«˜ãƒªã‚¹ã‚¯', medium: 'ä¸­ãƒªã‚¹ã‚¯', low: 'ä½ãƒªã‚¹ã‚¯', none: 'å•é¡Œãªã—' };
  return map[level] || level;
}

function getScore(results) {
  if (results.length === 0) return { grade: 'A', score: 95, label: 'å•é¡Œãªã—', color: 'var(--success)' };
  const critical = results.filter(r => r.severity === 'critical').length;
  const high = results.filter(r => r.severity === 'high').length;
  const med = results.filter(r => r.severity === 'medium').length;
  const low = results.filter(r => r.severity === 'low').length;
  const total = critical * 30 + high * 15 + med * 8 + low * 3;
  if (total >= 30) return { grade: 'D', score: Math.max(0, 100 - total), label: 'è¦ä¿®æ­£ï¼ˆé‡å¤§ï¼‰', color: 'var(--danger)' };
  if (total >= 15) return { grade: 'C', score: Math.max(30, 100 - total), label: 'è¦ç¢ºèªï¼ˆè¦ä¿®æ­£ï¼‰', color: 'var(--warning)' };
  if (total >= 5) return { grade: 'B', score: Math.max(60, 100 - total), label: 'è»½å¾®ãªå•é¡Œã‚ã‚Š', color: 'var(--primary)' };
  return { grade: 'A', score: 90, label: 'æ¦‚ã­å•é¡Œãªã—', color: 'var(--success)' };
}

function highlightText(text, results) {
  let html = escHtml(text);
  // Collect all match positions for highlight
  const spans = [];
  results.forEach(r => {
    r.matches.forEach(m => {
      const kwRegex = new RegExp(escRegex(m.matched), 'g');
      let match;
      while ((match = kwRegex.exec(text)) !== null) {
        spans.push({ start: match.index, end: match.index + match[0].length, severity: r.severity, text: match[0] });
      }
    });
  });
  spans.sort((a, b) => b.start - a.start);
  const chars = text.split('');
  spans.forEach(s => {
    const cls = `hl-${s.severity}`;
    chars.splice(s.end, 0, '</span>');
    chars.splice(s.start, 0, `<span class="${cls}">`);
  });
  return chars.join('').replace(/\n/g, '<br>');
}

function escHtml(t) { return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escRegex(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCheckItems(results) {
  if (results.length === 0) return `<div style="text-align:center;padding:24px;color:var(--success)">âœ… è–¬æ©Ÿæ³•ä¸Šã®å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</div>`;
  return results.map(r => `
    <div class="check-item check-item-${r.severity}">
      <div class="check-item-header">
        <div class="check-item-title">${r.icon} ${r.category} â€” ã€Œ${r.keyword}ã€</div>
        <span class="risk-badge risk-${r.severity}">${getRiskLabel(r.severity)}</span>
      </div>
      <div class="check-item-body">
        ${r.matches.map(m => `
          <div class="violation-text violation-text-${r.severity}">
            ...${escHtml(m.context).replace(escRegex(escHtml(m.matched)), `<span class="highlight-${r.severity}">${escHtml(m.matched)}</span>`)}...
          </div>
        `).join('')}
        <div class="violation-reason">âš ï¸ ${r.reason}</div>
        <div class="suggestion-box">
          <div class="suggestion-label">ğŸ’¡ ä¿®æ­£ææ¡ˆ</div>
          <div class="suggestion-text">${r.suggestion}</div>
        </div>
      </div>
    </div>
  `).join('');
}

function statusBadge(status) {
  const map = {
    draft: ['ä¸‹æ›¸ã', 'draft'],
    submitted: ['æå‡ºæ¸ˆã¿', 'submitted'],
    reviewing: ['ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­', 'reviewing'],
    approved: ['âœ“ æ‰¿èªæ¸ˆã¿', 'approved'],
    revision: ['è¦ä¿®æ­£', 'revision'],
    rejected: ['å´ä¸‹', 'rejected'],
  };
  const [label, cls] = map[status] || [status, 'draft'];
  return `<span class="status-badge status-${cls}">${label}</span>`;
}

function riskBadge(level) {
  const label = getRiskLabel(level);
  return `<span class="risk-badge risk-${level}">${label}</span>`;
}

function priorityDot(p) {
  if (p === 'urgent') return '<span style="color:var(--danger);font-size:12px;font-weight:700">â— è‡³æ€¥</span>';
  if (p === 'high') return '<span style="color:var(--warning);font-size:12px;font-weight:700">â— é«˜</span>';
  return '<span style="color:var(--slate-400);font-size:12px">â— é€šå¸¸</span>';
}

function formatDate(d) {
  if (!d || d === 'â€”') return 'â€”';
  const date = new Date(d);
  return `${date.getMonth() + 1}/${date.getDate()}`;
}

function categoryIcon(cat) {
  const map = { 'åŒ–ç²§å“': 'ğŸ’„', 'åŒ»è–¬å“': 'ğŸ’Š', 'åŒ»è–¬éƒ¨å¤–å“': 'ğŸ§´', 'ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ': 'ğŸ’Š', 'å¥åº·é£Ÿå“': 'ğŸ¥—' };
  return map[cat] || 'ğŸ“¦';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectRole(role, el) {
  selectedRole = role;
  document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  if (role === 'agency') {
    document.getElementById('loginEmail').value = 'agency@adpro.jp';
  } else {
    document.getElementById('loginEmail').value = 'client@medicalbeau.co.jp';
  }
}

function doLogin() {
  currentUser.role = selectedRole;
  if (selectedRole === 'agency') {
    currentUser.name = 'ç”°ä¸­ é›…äºº'; currentUser.company = 'ADãƒ—ãƒ­æ ªå¼ä¼šç¤¾';
  } else {
    currentUser.name = 'å±±ç”° èŠ±å­'; currentUser.company = 'æ ªå¼ä¼šç¤¾ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£';
  }
  document.getElementById('loginScreen').style.display = 'none';
  const app = document.getElementById('appShell');
  app.style.display = 'flex';
  app.classList.add('visible');
  setupUser();
  renderDashboard();
  renderCRTable(MOCK_CRS);
}

function doLogout() {
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('appShell').style.display = 'none';
}

function setupUser() {
  const avatar = document.getElementById('sidebarAvatar');
  const name = document.getElementById('sidebarName');
  const badge = document.getElementById('sidebarBadge');
  const navNewCR = document.getElementById('navNewCR');
  name.textContent = currentUser.name;
  avatar.textContent = currentUser.name[0];
  if (currentUser.role === 'agency') {
    avatar.style.background = '#2563EB';
    badge.textContent = 'ä»£ç†åº—';
    badge.className = 'user-role-badge badge-agency';
    navNewCR.style.display = 'flex';
  } else {
    avatar.style.background = '#7C3AED';
    badge.textContent = 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ';
    badge.className = 'user-role-badge badge-client';
    navNewCR.style.display = 'none';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navigate(view, navEl) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('view-' + view).classList.add('active');
  if (navEl) navEl.classList.add('active');
  currentView = view;
  const titles = { dashboard: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', crlist: 'CRä¸€è¦§', newcr: 'æ–°è¦CRä½œæˆ', yakki: 'è–¬æ©Ÿæ³• AIãƒã‚§ãƒƒã‚«ãƒ¼', detail: 'CRè©³ç´°' };
  document.getElementById('pageTitle').textContent = titles[view] || view;
  const actionsEl = document.getElementById('pageActions');
  actionsEl.innerHTML = '';
  if (view === 'crlist' && currentUser.role === 'agency') {
    actionsEl.innerHTML = `<button class="btn btn-primary btn-sm" onclick="navigate('newcr', document.querySelector('[onclick*=newcr]'))">+ æ–°è¦CRä½œæˆ</button>`;
  }
  if (view === 'yakki') {
    document.getElementById('yakkiInput').addEventListener('input', function() {
      document.getElementById('charCount').textContent = this.value.length + 'æ–‡å­—';
    });
  }
  // Scroll to top
  document.querySelector('.page-content').scrollTop = 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard() {
  const recentList = document.getElementById('recentCRList');
  const recent = MOCK_CRS.slice(0, 5);
  recentList.innerHTML = recent.map(cr => `
    <div class="recent-item" onclick="openCRDetail('${cr.id}')">
      <div class="recent-icon" style="background:${statusColors[cr.status] || '#EFF6FF'}">${categoryIcon(cr.category)}</div>
      <div class="recent-info">
        <div class="recent-name">${cr.title}</div>
        <div class="recent-client">${cr.client}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        ${statusBadge(cr.status)}
        <span class="recent-date">${formatDate(cr.submittedDate)}</span>
      </div>
    </div>
  `).join('');
}

const statusColors = {
  draft: '#F1F5F9', submitted: '#EFF6FF', reviewing: '#FFFBEB',
  approved: '#ECFDF5', revision: '#FFF7ED', rejected: '#FEF2F2',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CR TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCRTable(list) {
  const tbody = document.getElementById('crTableBody');
  if (list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-text">CRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div><div class="empty-sub">æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„</div></div></td></tr>`;
    return;
  }
  tbody.innerHTML = list.map(cr => `
    <tr onclick="openCRDetail('${cr.id}')">
      <td><div class="cr-id">${cr.id}</div></td>
      <td>
        <div class="cr-name">${cr.title}</div>
        <div class="cr-client">${cr.client}</div>
      </td>
      <td><span class="tag">${categoryIcon(cr.category)} ${cr.category}</span></td>
      <td>${statusBadge(cr.status)}</td>
      <td>${riskBadge(cr.riskLevel)}</td>
      <td><div class="cr-date">${cr.submittedDate}</div></td>
      <td><div class="cr-date">${cr.assignee}</div></td>
    </tr>
  `).join('');
}

function filterCRs() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const status = document.getElementById('statusFilter').value;
  const cat = document.getElementById('categoryFilter').value;
  const filtered = MOCK_CRS.filter(cr => {
    const matchQ = !q || cr.title.toLowerCase().includes(q) || cr.client.toLowerCase().includes(q);
    const matchStatus = !status || cr.status === status;
    const matchCat = !cat || cr.category === cat;
    return matchQ && matchStatus && matchCat;
  });
  renderCRTable(filtered);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CR DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCRDetail(id) {
  currentCRId = id;
  const cr = MOCK_CRS.find(c => c.id === id);
  if (!cr) return;
  navigate('detail', null);

  const results = runCheck(cr.copy);
  const risk = getRiskLevel(results);
  const score = getScore(results);
  const isAgency = currentUser.role === 'agency';
  const isClient = currentUser.role === 'client';

  // AI Banner
  let aiBanner = '';
  if (risk === 'critical') {
    aiBanner = `<div class="ai-check-banner ai-check-critical"><div class="ai-icon">ğŸš¨</div><div><div class="ai-summary-title">è–¬æ©Ÿæ³• Criticalé•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ</div><div class="ai-summary-desc">${results.filter(r => r.severity === 'critical').length}ä»¶ã®é‡å¤§ãªå•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚æ²è¼‰å‰ã«å¿…ãšä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚</div></div></div>`;
  } else if (risk === 'high' || risk === 'medium') {
    aiBanner = `<div class="ai-check-banner ai-check-warning"><div class="ai-icon">âš ï¸</div><div><div class="ai-summary-title">è–¬æ©Ÿæ³•ä¸Šã€ç¢ºèªãŒå¿…è¦ãªè¡¨ç¾ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</div><div class="ai-summary-desc">${results.length}ä»¶ã®å•é¡Œå€™è£œãŒã‚ã‚Šã¾ã™ã€‚æ‹…å½“è€…ã¨ç¢ºèªã®ã†ãˆä¿®æ­£ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚</div></div></div>`;
  } else {
    aiBanner = `<div class="ai-check-banner ai-check-safe"><div class="ai-icon">âœ…</div><div><div class="ai-summary-title">è–¬æ©Ÿæ³•ä¸Šã®é‡å¤§ãªå•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</div><div class="ai-summary-desc">ãƒ†ã‚­ã‚¹ãƒˆã«æ˜ã‚‰ã‹ãªè–¬æ©Ÿæ³•é•åã¯è¦‹å½“ãŸã‚Šã¾ã›ã‚“ã€‚</div></div></div>`;
  }

  // Approval panel
  let approvalPanel = '';
  if (isClient && (cr.status === 'submitted' || cr.status === 'reviewing')) {
    approvalPanel = `
      <div class="action-buttons">
        <button class="btn btn-success" onclick="openModal('approve','${id}')">âœ“ æ‰¿èªã™ã‚‹</button>
        <button class="btn btn-warning" onclick="openModal('revision','${id}')">â†© è¦ä¿®æ­£ã¨ã—ã¦è¿”å´</button>
        <button class="btn btn-danger" onclick="openModal('reject','${id}')">âœ• å´ä¸‹ã™ã‚‹</button>
      </div>`;
  } else if (isAgency && cr.status === 'revision') {
    approvalPanel = `
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="openModal('resubmit','${id}')">ğŸ“¤ ä¿®æ­£ç‰ˆã‚’å†æå‡º</button>
      </div>`;
  } else {
    const statusDesc = {
      approved: 'âœ… ã“ã®CRã¯æ‰¿èªæ¸ˆã¿ã§ã™',
      draft: 'ğŸ“ ä¸‹æ›¸ãçŠ¶æ…‹ã§ã™ã€‚æå‡ºã—ã¦ãã ã•ã„',
      rejected: 'âŒ ã“ã®CRã¯å´ä¸‹ã•ã‚Œã¾ã—ãŸ',
      submitted: 'â³ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™',
      reviewing: 'ğŸ” ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã§ã™',
    };
    approvalPanel = `<p style="color:var(--slate-500);font-size:13px">${statusDesc[cr.status] || ''}</p>`;
  }

  // Files
  const filesHtml = cr.files.length === 0 ? '<div style="color:var(--slate-400);font-size:13px">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãªã—</div>' :
    cr.files.map(f => `<div class="upload-file-chip">ğŸ“„ ${f.name} <span style="color:var(--slate-400)">${f.size}</span></div>`).join('');

  // Comments
  const avatarColors = { agency: '#2563EB', client: '#7C3AED' };
  const commentsHtml = cr.comments.length === 0 ? '<div style="color:var(--slate-400);font-size:13px">ã‚³ãƒ¡ãƒ³ãƒˆãªã—</div>' :
    cr.comments.map(c => `
      <div class="comment-item">
        <div class="comment-avatar" style="background:${avatarColors[c.role] || '#64748B'}">${c.author[0]}</div>
        <div class="comment-bubble">
          <div class="comment-header">
            <span class="comment-author">${c.author}</span>
            <span class="tag" style="font-size:10px">${c.role === 'agency' ? 'ä»£ç†åº—' : 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ'}</span>
            <span class="comment-time">${c.time}</span>
          </div>
          <div class="comment-text">${escHtml(c.text)}</div>
        </div>
      </div>
    `).join('');

  const detailContent = document.getElementById('detailContent');
  detailContent.className = 'anim-in';
  detailContent.innerHTML = `
    <div class="back-btn" onclick="history.go(-1) || navigate('crlist', document.querySelector('[onclick*=crlist]'))">â† ä¸€è¦§ã«æˆ»ã‚‹</div>
    <div class="detail-header">
      <div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
          <div class="detail-title">${cr.title}</div>
          ${priorityDot(cr.priority)}
        </div>
        <div class="detail-meta">
          <div class="meta-item"><strong>ID:</strong> ${cr.id}</div>
          <div class="meta-item"><strong>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ:</strong> ${cr.client}</div>
          <div class="meta-item"><strong>ã‚«ãƒ†ã‚´ãƒª:</strong> ${categoryIcon(cr.category)} ${cr.category}</div>
          <div class="meta-item"><strong>ç´ æ:</strong> ${cr.type}</div>
          <div class="meta-item"><strong>æœŸé™:</strong> ${cr.deadline}</div>
          <div class="meta-item"><strong>æ‹…å½“:</strong> ${cr.assignee}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:flex-start;flex-shrink:0">
        ${statusBadge(cr.status)}
        ${riskBadge(risk)}
      </div>
    </div>

    <div class="detail-grid">
      <div class="detail-main">
        <!-- AI CHECK BANNER -->
        ${aiBanner}

        <!-- COPY TEXT -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼</div>
            <span style="font-size:12px;color:var(--slate-400)">ãƒã‚¤ãƒ©ã‚¤ãƒˆã¯è–¬æ©Ÿæ³•ãƒã‚§ãƒƒã‚¯çµæœ</span>
          </div>
          <div class="card-body">
            <div class="copy-text">${highlightText(cr.copy, results)}</div>
          </div>
        </div>

        <!-- YAKKI CHECK RESULTS -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">âš–ï¸ è–¬æ©Ÿæ³• AI ãƒã‚§ãƒƒã‚¯çµæœ</div>
            <span class="risk-badge risk-${risk}">${results.length}ä»¶æ¤œå‡º</span>
          </div>
          <div class="card-body">
            <div class="check-items">${renderCheckItems(results)}</div>
          </div>
        </div>

        <!-- COMMENTS -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</div>
            <span style="font-size:12px;color:var(--slate-400)">${cr.comments.length}ä»¶</span>
          </div>
          <div class="card-body">
            <div class="comment-list">${commentsHtml}</div>
            <div class="divider"></div>
            <div class="comment-input-area">
              <div class="comment-avatar" style="background:${currentUser.role === 'agency' ? '#2563EB' : '#7C3AED'};width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:13px;font-weight:700;flex-shrink:0">${currentUser.name[0]}</div>
              <div style="flex:1">
                <textarea class="comment-textarea" id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..." rows="3"></textarea>
                <div style="display:flex;justify-content:flex-end;margin-top:8px">
                  <button class="btn btn-primary btn-sm" onclick="addComment('${cr.id}')">é€ä¿¡</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SIDEBAR -->
      <div class="detail-sidebar">
        <!-- STATUS CARD -->
        <div class="card">
          <div class="card-header"><div class="card-title">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div></div>
          <div class="card-body">
            ${approvalPanel}
          </div>
        </div>

        <!-- RISK SUMMARY -->
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ“Š ãƒªã‚¹ã‚¯ã‚µãƒãƒªãƒ¼</div></div>
          <div class="card-body">
            <div style="text-align:center;margin-bottom:16px">
              <div class="score-circle score-${score.grade}" style="margin:0 auto 8px">${score.grade}</div>
              <div style="font-size:14px;font-weight:700;color:${score.color}">${score.label}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px">
              ${['critical','high','medium','low'].map(sev => {
                const cnt = results.filter(r => r.severity === sev).length;
                const labels = { critical: 'ğŸš¨ Critical', high: 'âš ï¸ é«˜ãƒªã‚¹ã‚¯', medium: 'ğŸ“Š ä¸­ãƒªã‚¹ã‚¯', low: 'ğŸ’¬ ä½ãƒªã‚¹ã‚¯' };
                const colors = { critical: 'var(--danger)', high: 'var(--warning)', medium: '#CA8A04', low: 'var(--success)' };
                return `<div style="display:flex;align-items:center;justify-content:space-between">
                  <span style="font-size:12.5px;color:var(--slate-600)">${labels[sev]}</span>
                  <span style="font-size:13px;font-weight:700;color:${cnt > 0 ? colors[sev] : 'var(--slate-300)'}">${cnt}ä»¶</span>
                </div>`;
              }).join('')}
            </div>
          </div>
        </div>

        <!-- FILES -->
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</div></div>
          <div class="card-body">
            <div style="display:flex;flex-wrap:wrap;gap:8px">${filesHtml}</div>
          </div>
        </div>

        <!-- TIMELINE -->
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ• å±¥æ­´</div></div>
          <div class="card-body">
            <div class="activity-list">
              <div class="activity-item">
                <div class="activity-dot" style="background:var(--primary)"></div>
                <div>
                  <div class="activity-text">æå‡º</div>
                  <div class="activity-time">${cr.submittedDate}</div>
                </div>
              </div>
              ${cr.status !== 'draft' && cr.status !== 'submitted' ? `
              <div class="activity-item">
                <div class="activity-dot" style="background:var(--warning)"></div>
                <div>
                  <div class="activity-text">ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹</div>
                  <div class="activity-time">${cr.submittedDate}</div>
                </div>
              </div>` : ''}
              ${cr.status === 'approved' ? `
              <div class="activity-item">
                <div class="activity-dot" style="background:var(--success)"></div>
                <div>
                  <div class="activity-text">æ‰¿èªæ¸ˆã¿</div>
                  <div class="activity-time">${cr.deadline}</div>
                </div>
              </div>` : ''}
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addComment(crId) {
  const input = document.getElementById('commentInput');
  const text = input.value.trim();
  if (!text) { showToast('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const cr = MOCK_CRS.find(c => c.id === crId);
  if (!cr) return;
  cr.comments.push({ author: currentUser.name, role: currentUser.role, time: 'ãŸã£ãŸä»Š', text });
  input.value = '';
  openCRDetail(crId);
  showToast('ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APPROVAL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(type, crId) {
  pendingActionType = type;
  currentCRId = crId;
  const modal = document.getElementById('approvalModal');
  const title = document.getElementById('modalTitle');
  const desc = document.getElementById('modalDesc');
  const btn = document.getElementById('modalConfirmBtn');
  const configs = {
    approve: { title: 'CRã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ', desc: 'æ‰¿èªã™ã‚‹ã¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ã‚·ãƒ¼ã«é€šçŸ¥ãŒé€ã‚‰ã‚Œã¾ã™ã€‚', btnClass: 'btn-success', btnLabel: 'âœ“ æ‰¿èªã™ã‚‹' },
    revision: { title: 'è¦ä¿®æ­£ã¨ã—ã¦è¿”å´ã—ã¾ã™ã‹ï¼Ÿ', desc: 'ä¿®æ­£ä¾é ¼ã‚³ãƒ¡ãƒ³ãƒˆã¨å…±ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ã‚·ãƒ¼ã«è¿”å´ã•ã‚Œã¾ã™ã€‚', btnClass: 'btn-warning', btnLabel: 'â†© è¦ä¿®æ­£ã§è¿”å´' },
    reject: { title: 'CRã‚’å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ', desc: 'ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚å´ä¸‹ç†ç”±ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚', btnClass: 'btn-danger', btnLabel: 'âœ• å´ä¸‹ã™ã‚‹' },
    resubmit: { title: 'ä¿®æ­£ç‰ˆã‚’å†æå‡ºã—ã¾ã™ã‹ï¼Ÿ', desc: 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ä¿®æ­£ç‰ˆã¨ã—ã¦æå‡ºã•ã‚Œã¾ã™ã€‚', btnClass: 'btn-primary', btnLabel: 'ğŸ“¤ å†æå‡ºã™ã‚‹' },
  };
  const cfg = configs[type];
  title.textContent = cfg.title;
  desc.textContent = cfg.desc;
  btn.className = `btn ${cfg.btnClass}`;
  btn.textContent = cfg.btnLabel;
  modal.classList.add('open');
  document.getElementById('modalComment').value = '';
}

function closeModal() {
  document.getElementById('approvalModal').classList.remove('open');
  pendingActionType = null;
}

function confirmAction() {
  const comment = document.getElementById('modalComment').value.trim();
  const cr = MOCK_CRS.find(c => c.id === currentCRId);
  if (!cr) { closeModal(); return; }
  const statusMap = { approve: 'approved', revision: 'revision', reject: 'rejected', resubmit: 'submitted' };
  cr.status = statusMap[pendingActionType] || cr.status;
  if (comment) {
    cr.comments.push({ author: currentUser.name, role: currentUser.role, time: 'ãŸã£ãŸä»Š', text: comment });
  }
  closeModal();
  const msgs = { approve: 'âœ… CRã‚’æ‰¿èªã—ã¾ã—ãŸ', revision: 'â†© è¦ä¿®æ­£ã¨ã—ã¦è¿”å´ã—ã¾ã—ãŸ', reject: 'âœ• CRã‚’å´ä¸‹ã—ã¾ã—ãŸ', resubmit: 'ğŸ“¤ ä¿®æ­£ç‰ˆã‚’å†æå‡ºã—ã¾ã—ãŸ' };
  showToast(msgs[pendingActionType]);
  openCRDetail(currentCRId);
  updateBadge();
}

function updateBadge() {
  const pending = MOCK_CRS.filter(c => c.status === 'submitted' || c.status === 'reviewing').length;
  const badge = document.getElementById('pendingBadge');
  badge.textContent = pending;
  badge.style.display = pending > 0 ? '' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEW CR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const mockFiles = ['LP_design_draft.pdf', 'banner_v2.jpg', 'SNS_image.png', 'video_script.docx'];
let uploadCount = 0;

function simulateUpload() {
  if (uploadCount >= mockFiles.length) { showToast('ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã™ã¹ã¦è¿½åŠ æ¸ˆã¿ã§ã™'); return; }
  const f = mockFiles[uploadCount++];
  const container = document.getElementById('uploadedFiles');
  const chip = document.createElement('div');
  chip.className = 'upload-file-chip';
  chip.innerHTML = `ğŸ“„ ${f} <span style="color:var(--slate-400);font-size:11px">è¿½åŠ æ¸ˆã¿</span>`;
  container.appendChild(chip);
  showToast(`${f} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
}

function preCheckCopy() {
  const text = document.getElementById('newCRCopy').value.trim();
  const result = document.getElementById('preCheckResult');
  if (!text) { showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const results = runCheck(text);
  const risk = getRiskLevel(results);
  if (risk === 'none') {
    result.innerHTML = `<div style="background:var(--success-light);border:1px solid #A7F3D0;border-radius:10px;padding:14px;margin-top:12px;color:var(--success);font-weight:600">âœ… è–¬æ©Ÿæ³•ä¸Šã®å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</div>`;
  } else {
    result.innerHTML = `
      <div style="margin-top:12px">
        <div style="font-size:13px;font-weight:700;color:var(--slate-700);margin-bottom:10px">âš–ï¸ äº‹å‰ãƒã‚§ãƒƒã‚¯çµæœï¼ˆ${results.length}ä»¶ã®å•é¡Œã‚’æ¤œå‡ºï¼‰</div>
        <div class="check-items">${renderCheckItems(results)}</div>
      </div>`;
  }
}

function saveDraft() {
  const title = document.getElementById('newCRTitle').value.trim();
  if (!title) { showToast('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  showToast('ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

function submitCR() {
  const title = document.getElementById('newCRTitle').value.trim();
  const client = document.getElementById('newCRClient').value.trim();
  const category = document.getElementById('newCRCategory').value;
  const type = document.getElementById('newCRType').value;
  const copy = document.getElementById('newCRCopy').value.trim();
  if (!title || !client || !category || !type) { showToast('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  const results = runCheck(copy);
  const risk = getRiskLevel(results);
  const newId = 'CR-2024-0' + (MOCK_CRS.length + 25);
  const today = new Date().toISOString().split('T')[0];

  MOCK_CRS.unshift({
    id: newId, title, client, category, type,
    status: 'submitted', riskLevel: risk,
    submittedDate: today, deadline: document.getElementById('newCRDeadline').value || 'â€”',
    assignee: 'æœªå‰²å½“', priority: document.getElementById('newCRPriority').value,
    copy: copy || 'ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãªã—ï¼‰',
    files: [], comments: [],
  });

  renderDashboard();
  renderCRTable(MOCK_CRS);
  updateBadge();
  showToast('ğŸ‰ CRã‚’æå‡ºã—ã¾ã—ãŸï¼ID: ' + newId);
  navigate('crlist', document.querySelector('[onclick*="crlist"]'));
  // Reset form
  ['newCRTitle','newCRClient','newCRCopy','newCRNote'].forEach(id => { document.getElementById(id).value = ''; });
  document.getElementById('newCRCategory').value = '';
  document.getElementById('newCRType').value = '';
  document.getElementById('preCheckResult').innerHTML = '';
  document.getElementById('uploadedFiles').innerHTML = '';
  uploadCount = 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  YAKKI-HO STANDALONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SAMPLES = [
  `ã“ã®ã‚¯ãƒªãƒ¼ãƒ ã‚’å¡—ã‚Œã°ã€ã‚·ãƒŸãŒçµ¶å¯¾ã«æ¶ˆãˆã¾ã™ï¼
è‚Œã‚’å†ç”Ÿãƒ»ä¿®å¾©ã—ã€è€åŒ–ã‚’æ²»ç™‚ã™ã‚‹å¥‡è·¡ã®ç¾å®¹æ¶²ã€‚
æ¥­ç•ŒNo.1ï¼ˆâ€»è‡ªç¤¾èª¿ã¹ï¼‰ã®æµ¸é€åŠ›ã§ã€ç´°èƒã‚’æ´»æ€§åŒ–ã€‚
å®Œç’§ãªç¾è‚Œã‚’ã€é©šç•°çš„ãªé€Ÿã•ã§å®Ÿç¾ã—ã¾ã™ï¼`,

  `åŒ»è–¬éƒ¨å¤–å“ è‚²æ¯›å‰¤ã€ŒRe:Growthã€
ç™ºæ¯›ã‚’ä¿ƒé€²ã—ã€è„±æ¯›ã‚’å¿…ãšæ­¢ã‚ã‚‹æ¬¡ä¸–ä»£è‚²æ¯›å‰¤ã€‚
æœ‰åŠ¹æˆåˆ†ãƒŸãƒã‚­ã‚·ã‚¸ãƒ«é…åˆã§è–„æ¯›ã‚’ç¢ºå®Ÿã«æ²»ã™ï¼
ä»–ç¤¾è£½å“ã‚ˆã‚Š3å€ã®è‚²æ¯›åŠ¹æœï¼ˆâ€»å½“ç¤¾æ¯”ï¼‰ã€‚
æ¥­ç•Œæœ€å¼·ã®å‡¦æ–¹ã§ã€è‹¥è¿”ã‚Šã‚’å®Ÿç¾ã—ã¾ã™ã€‚`,
];

function loadSample(n) {
  document.getElementById('yakkiInput').value = SAMPLES[n - 1] || '';
  document.getElementById('charCount').textContent = SAMPLES[n-1].length + 'æ–‡å­—';
  document.getElementById('yakkiResults').innerHTML = '';
}

function runYakkiCheck() {
  const text = document.getElementById('yakkiInput').value.trim();
  if (!text) { showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const results = runCheck(text);
  const risk = getRiskLevel(results);
  const score = getScore(results);

  const catBreakdown = ['critical','high','medium','low'].map(sev => {
    const cnt = results.filter(r => r.severity === sev).length;
    const pct = Math.min(100, cnt * 30);
    const colors = { critical: 'var(--danger)', high: 'var(--warning)', medium: '#CA8A04', low: 'var(--success)' };
    const labels = { critical: 'ğŸš¨ Criticalé•å', high: 'âš ï¸ é«˜ãƒªã‚¹ã‚¯è¡¨ç¾', medium: 'ğŸ“Š ä¸­ãƒªã‚¹ã‚¯è¡¨ç¾', low: 'ğŸ’¬ ä½ãƒªã‚¹ã‚¯è¡¨ç¾' };
    return `<div class="score-cat-row">
      <span class="score-cat-name">${labels[sev]}</span>
      <div class="score-cat-bar"><div class="score-cat-fill" style="width:${pct}%;background:${colors[sev]}"></div></div>
      <span class="score-cat-val" style="color:${cnt > 0 ? colors[sev] : 'var(--slate-300)'}">${cnt}</span>
    </div>`;
  }).join('');

  const highlightedText = highlightText(text, results);

  const resultHtml = `
    <div class="anim-in">
      <div class="score-overview">
        <div class="score-gauge">
          <div class="score-circle score-${score.grade}">${score.grade}</div>
          <div style="font-size:13px;font-weight:700;color:${score.color}">${score.label}</div>
          <div style="font-size:12px;color:var(--slate-400);margin-top:4px">ã‚¹ã‚³ã‚¢: ${score.score}/100</div>
        </div>
        <div class="card" style="padding:16px">
          <div style="font-size:13px;font-weight:700;color:var(--slate-700);margin-bottom:12px">ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒªã‚¹ã‚¯</div>
          <div class="score-cats">${catBreakdown}</div>
        </div>
      </div>

      <div class="card" style="margin-bottom:16px">
        <div class="card-header">
          <div class="card-title">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºï¼‰</div>
        </div>
        <div class="card-body">
          <div class="copy-text">${highlightedText}</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">âš–ï¸ æ¤œå‡ºçµæœï¼ˆ${results.length}ä»¶ï¼‰</div>
          ${riskBadge(risk)}
        </div>
        <div class="card-body">
          <div class="check-items">${renderCheckItems(results)}</div>
        </div>
      </div>

      <div style="margin-top:16px;padding:14px;background:var(--slate-50);border-radius:10px;border:1px solid var(--slate-200);font-size:12.5px;color:var(--slate-500)">
        âš ï¸ ã“ã®ãƒã‚§ãƒƒã‚¯çµæœã¯AIã«ã‚ˆã‚‹å‚è€ƒæƒ…å ±ã§ã™ã€‚è–¬æ©Ÿæ³•ã®è§£é‡ˆã¯å€‹åˆ¥æ¡ˆä»¶ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚æœ€çµ‚åˆ¤æ–­ã¯è–¬äº‹å°‚é–€å®¶ã¾ãŸã¯æ³•å‹™æ‹…å½“è€…ã«ã”ç¢ºèªãã ã•ã„ã€‚
      </div>
    </div>`;

  document.getElementById('yakkiResults').innerHTML = resultHtml;
  document.querySelector('.page-content').scrollTo({ top: 300, behavior: 'smooth' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  renderDashboard();
  renderCRTable(MOCK_CRS);
  updateBadge();
  // Set default deadline
  const d = new Date(); d.setDate(d.getDate() + 7);
  const dl = document.getElementById('newCRDeadline');
  if (dl) dl.value = d.toISOString().split('T')[0];
});

// Close modal on overlay click
document.getElementById('approvalModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>
</body>
</html>
